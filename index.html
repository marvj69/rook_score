<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Rook - Game Scoring Screen</title>

  <!-- Link to your manifest.json file -->
  <link rel="manifest" href="manifest.json" />

  <!-- (Optional) Theme color meta tag -->
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <link rel="icon" href="icons/icon-192x192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:"class"}</script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px)
      }
      to {
        opacity: 1;
        transform: translateY(0)
      }
    }
    .animate-fade-in {
      animation: fadeIn 0.5s ease-out
    }
    .score-input-container {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.4s ease-in-out
    }
    .score-input-container.show {
      max-height: 1000px;
      opacity: 1;
      transform: translateY(0)
    }
    .focus-outline:focus {
      outline: 2px dashed #3182ce;
      outline-offset: 2px
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none
    }
    #saveIndicator {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      background-color: rgba(16,185,129,.7);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      box-shadow: 0 2px 4px rgba(0,0,0,.1);
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 1000;
      font-size: 0.875rem
    }
    #saveIndicator.show {
      opacity: 1
    }
    .hamburger-menu {
      display: flex;
      flex-direction: column;
      cursor: pointer;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1100;
      transition: all 0.3s ease
    }
    .bar {
      width: 30px;
      height: 4px;
      background-color: #333;
      margin: 5px 0;
      transition: all 0.3s
    }
    html.dark .bar {
      background-color: #fff
    }
    .hamburger-menu.open .bar:nth-child(1) {
      transform: rotate(45deg) translate(10px,10px)
    }
    .hamburger-menu.open .bar:nth-child(2) {
      opacity: 0
    }
    .hamburger-menu.open .bar:nth-child(3) {
      transform: rotate(-45deg) translate(10px,-10px)
    }
    nav {
      position: fixed;
      top: 0;
      left: -300px;
      width: 250px;
      height: 100%;
      background-color: #fff;
      z-index: 1200;
      transition: left 0.3s ease;
      box-shadow: 2px 0 5px rgba(0,0,0,.1)
    }
    nav.show {
      left: 0
    }
    html.dark nav {
      background-color: #2d3748
    }
    nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      margin-top: 60px
    }
    nav ul li {
      margin: 0;
      border-bottom: 1px solid #e0e0e0
    }
    nav ul li:last-child {
      border-bottom: none
    }
    nav ul li a,
    nav ul li button {
      color: #333;
      text-decoration: none;
      font-size: 20px;
      padding: 15px 20px;
      display: block;
      transition: background-color 0.3s ease;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit
    }
    nav ul li a:hover,
    nav ul li button:hover {
      background-color: #f5f5f5
    }
    html.dark nav ul li a,
    html.dark nav ul li button {
      color: #fff
    }
    html.dark nav ul li a:hover,
    html.dark nav ul li button:hover {
      background-color: #4a5568
    }
    .close-menu {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #333;
      font-size: 30px;
      cursor: pointer
    }
    html.dark .close-menu {
      color: #fff
    }
    .menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,.5);
      z-index: 1150;
      display: none
    }
    .menu-overlay.show {
      display: block
    }
    .modal {
      transition: opacity 0.25s ease
    }
    .modal.hidden {
      display: none
    }
  </style>
</head>
<body class="bg-white text-gray-800 min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
  <div class="hamburger-menu" onclick="toggleMenu(event)" aria-label="Open Menu" role="button" tabindex="0" id="hamburgerIcon">
    <div class="bar"></div>
    <div class="bar"></div>
    <div class="bar"></div>
  </div>

  <nav id="menu">
    <ul>
      <li><a href="#" onclick="openSavedGamesModal();toggleMenu(event)">View Saved Games</a></li>
      <li><a href="#" onclick="handleNewGame();toggleMenu(event)">New Game</a></li>
      <li><a href="#" onclick="handleFreezerGame();toggleMenu(event)">Freeze Game</a></li>
      <li>
        <button id="darkModeToggle" onclick="toggleDarkMode(event)" class="flex items-center focus:outline-none">
          <span id="darkModeIcon"></span>
          <span id="darkModeLabel" class="ml-2">Dark Mode</span>
        </button>
      </li>
    </ul>
  </nav>

  <div id="menuOverlay" class="menu-overlay" onclick="closeMenuOverlay()" aria-hidden="true"></div>

  <div class="absolute top-0 right-0 m-4 p-2 text-gray-800 font-medium text-xs bg-white bg-opacity-70 rounded-full shadow px-3 py-1 dark:bg-gray-800 dark:text-gray-100" style="cursor:pointer" onclick="showEasterEgg()">
    <p>Version 1.1.2</p>
  </div>

  <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 space-y-6"></div>

  <div id="saveIndicator" class="hidden">Saved</div>

  <!-- Saved Games Modal -->
  <div id="savedGamesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="savedGamesTitle">
    <div class="bg-white w-full max-w-4xl rounded-xl shadow-lg overflow-y-auto max-h-full dark:bg-gray-800">
      <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-gray-700">
        <h3 id="savedGamesTitle" class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Saved Games</h3>
        <button id="closeSavedGamesModalBtn" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-gray-300 dark:hover:text-gray-100" aria-label="Close Saved Games Modal">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-5 space-y-6">
        <div class="rounded-xl shadow-sm p-4 bg-gray-50 dark:bg-gray-700">
          <h4 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Completed Games</h4>
          <div id="savedGamesList" class="space-y-4"></div>
        </div>
        <div class="rounded-xl shadow-sm p-4 bg-gray-50 dark:bg-gray-700">
          <h4 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Freezer Games</h4>
          <div id="freezerGamesList" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Game Modal -->
  <div id="saveGameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="saveGameModalTitle">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800">
      <div class="p-6">
        <h2 id="saveGameModalTitle" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Save Game</h2>
        <form id="saveGameForm" class="space-y-4">
          <div>
            <label for="player1Name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Player 1 (Us)</label>
            <input type="text" id="player1Name" name="player1Name" required class="mt-1 block w-full border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100" placeholder="Enter Player 1 Name">
          </div>
          <div>
            <label for="player2Name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Player 2 (Dem)</label>
            <input type="text" id="player2Name" name="player2Name" required class="mt-1 block w-full border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100" placeholder="Enter Player 2 Name">
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" onclick="closeSaveGameModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 dark:focus:ring-gray-500">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Freeze Game Modal -->
  <div id="freezeGameModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="freezeGameModalTitle">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800">
      <div class="p-6">
        <h2 id="freezeGameModalTitle" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Freeze Game</h2>
        <form id="freezeGameForm" class="space-y-4">
          <div>
            <label for="freezeGameName" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Game Name</label>
            <input type="text" id="freezeGameName" name="freezeGameName" required class="mt-1 block w-full border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100" placeholder="Enter Freezer Game Name">
          </div>
          <div class="flex justify-end space-x-2">
            <button type="button" onclick="closeFreezeGameModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 dark:focus:ring-gray-500">Cancel</button>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400">Freeze</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
    <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800">
      <div class="p-6">
        <h2 id="confirmationModalTitle" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Confirm Action</h2>
        <p id="confirmationModalMessage" class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to proceed?</p>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelModalButton" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 dark:focus:ring-gray-500">Cancel</button>
          <button type="button" id="noModalButton" class="bg-yellow-600 text-white px-4 py-2 rounded-xl hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 dark:bg-yellow-500 dark:hover:bg-yellow-600 dark:focus:ring-yellow-400">No</button>
          <button type="button" id="confirmModalButton" class="bg-red-600 text-white px-4 py-2 rounded-xl hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-400">Yes</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    "use strict";

    // Icons object for various SVG icons used in the app
    const Icons = {
  AlertCircle: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-6 w-6" fill="none" 
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <path d="M12 8v4m0 4h.01"></path>
    </svg>
  `,
  Undo: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-5 w-5 mr-1" fill="none" 
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 7v6h6M21 17a9 9 0 0 0-9-9c-2.5 0-4.75.9-6.5 2.4L3 11"/>
    </svg>
  `,
  Trash: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-5 w-5" fill="none" 
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"/>
    </svg>
  `,
  Load: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-5 w-5 mr-1" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 11H6
               a2 2 0 012 2v6a2 2 0 01-2 2H4
               a2 2 0 01-2-2v-6
               a8.001 8.001 0 0115.356-2z"/>
    </svg>
  `,
  Sun: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-6 w-6" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 3v1m0 16v1m8.66-8.66h-1
               M4.34 12.66h-1m15.364 4.95l-.707-.707
               M6.343 6.343l-.707-.707
               m12.728 0l-.707.707
               M6.343 17.657l-.707.707
               M12 8a4 4 0 100 8 4 4 0 000-8z"/>
    </svg>
  `,
  Moon: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-6 w-6" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M21 12.79A9 9 0 1111.21 3
               7 7 0 0021 12.79z"/>
    </svg>
  `,
  Trophy: `
    <svg xmlns="http://www.w3.org/2000/svg" 
         class="h-8 w-8 inline-block mr-2" fill="none"
         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M3 10h18M7 10V4h10v6M7 10l-1 12h12
               l-1-12M7 10h10m-5 12v-6"/>
    </svg>
  `
};

    const presetBids = [120, 125, 130, 135, 140, "other"];
    const DEFAULT_STATE = {
      rounds: [],
      biddingTeam: "",
      bidAmount: "",
      customBidValue: "",
      showCustomBid: false,
      enterBidderPoints: false,
      error: "",
      gameOver: false,
      winner: null,
      savedScoreInputStates: { us: null, Dem: null },
      lastBidAmount: null,
      lastBidTeam: null
    };
    let state = { ...DEFAULT_STATE }, confettiTriggered = false, ephemeralCustomBid = "", ephemeralPoints = "",
      ACTIVE_GAME_KEY = "activeGameState", DARK_MODE_KEY = "darkModeEnabled", confirmationCallback = null,
      noCallback = null, cancelCallback = null;

    // Toggle dark mode
    function toggleDarkMode(e) {
      e.stopPropagation();
      const htmlEl = document.documentElement;
      const darkEnabled = htmlEl.classList.toggle("dark");
      localStorage.setItem(DARK_MODE_KEY, darkEnabled);
      updateDarkModeButton(darkEnabled);
      updateMetaThemeColor(darkEnabled);
    }

    function updateDarkModeButton(isDark) {
      const iconEl = document.getElementById("darkModeIcon");
      const labelEl = document.getElementById("darkModeLabel");
      if (iconEl && labelEl) {
        iconEl.innerHTML = isDark ? Icons.Sun : Icons.Moon;
        labelEl.textContent = isDark ? "Light Mode" : "Dark Mode";
      }
    }

    function initializeDarkMode() {
      const isDark = JSON.parse(localStorage.getItem(DARK_MODE_KEY));
      if (isDark) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
      updateDarkModeButton(isDark);
      updateMetaThemeColor(isDark);
    }

    function updateMetaThemeColor(isDark) {
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) {
        metaTheme.setAttribute("content", isDark ? "#1a202c" : "#ffffff");
      }
    }

    // Local Storage helpers
    const getLocalStorage = (key) => JSON.parse(localStorage.getItem(key)) || [];
    const setLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));

    // Show "Saved" indicator
    function showSaveIndicator() {
      const indicator = document.getElementById("saveIndicator");
      if (!indicator) return;
      indicator.classList.remove("hidden");
      indicator.classList.add("show");
      setTimeout(() => {
        indicator.classList.remove("show");
        indicator.classList.add("hidden");
      }, 1000);
    }

    // Load / Save current game state
    function loadCurrentGameState() {
      const savedState = localStorage.getItem(ACTIVE_GAME_KEY);
      if (savedState) {
        try {
          const parsed = JSON.parse(savedState);
          state = { ...state, ...parsed };
          renderApp();
        } catch (error) {
          console.error("Failed to parse saved game state:", error);
          localStorage.removeItem(ACTIVE_GAME_KEY);
        }
      }
    }

    function saveCurrentGameState() {
      if (state.gameOver) {
        localStorage.removeItem(ACTIVE_GAME_KEY);
      } else {
        localStorage.setItem(ACTIVE_GAME_KEY, JSON.stringify(state));
        showSaveIndicator();
      }
    }

    // Delete game utilities
    function deleteGame(localStorageKey, index, label) {
      const list = getLocalStorage(localStorageKey);
      openConfirmationModal(
        `Are you sure you want to delete this ${label}?`,
        () => {
          list.splice(index, 1);
          setLocalStorage(localStorageKey, list);
          renderSavedGames();
          renderFreezerGames();
          closeConfirmationModal();
        },
        () => {
          closeConfirmationModal();
        },
        () => {
          closeConfirmationModal();
        }
      );
    }

    // Hamburger menu toggles
    function bringHamburgerToFront() {
      document.getElementById("hamburgerIcon").style.zIndex = "9999";
    }

    function toggleMenu(e) {
      e.stopPropagation();
      const menu = document.getElementById("menu");
      const hamburger = document.getElementById("hamburgerIcon");
      const overlay = document.getElementById("menuOverlay");
      const isOpen = menu.classList.contains("show");
      if (isOpen) {
        menu.classList.remove("show");
        hamburger.classList.remove("open");
        overlay.classList.remove("show");
      } else {
        menu.classList.add("show");
        hamburger.classList.add("open");
        overlay.classList.add("show");
        bringHamburgerToFront();
      }
    }

    function closeMenuOverlay() {
      const menu = document.getElementById("menu");
      const hamburger = document.getElementById("hamburgerIcon");
      const overlay = document.getElementById("menuOverlay");
      menu.classList.remove("show");
      hamburger.classList.remove("open");
      overlay.classList.remove("show");
    }

    // Saved Games Modal
    function closeSavedGamesModal() {
      document.getElementById("savedGamesModal").classList.add("hidden");
    }

    // Confirmation Modal
    function openConfirmationModal(message, yesCallback, noCb, cancelCb) {
      const modal = document.getElementById("confirmationModal");
      const messageEl = document.getElementById("confirmationModalMessage");
      const yesBtn = document.getElementById("confirmModalButton");
      const noBtn = document.getElementById("noModalButton");
      const cancelBtn = document.getElementById("cancelModalButton");
      messageEl.textContent = message;
      confirmationCallback = yesCallback;
      noCallback = noCb;
      cancelCallback = cancelCb;
      modal.classList.remove("hidden");

      // Clone and rebind events to avoid multiple listeners
      const newYesBtn = yesBtn.cloneNode(true);
      yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
      const newNoBtn = noBtn.cloneNode(true);
      noBtn.parentNode.replaceChild(newNoBtn, noBtn);
      const newCancelBtn = cancelBtn.cloneNode(true);
      cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

      newYesBtn.addEventListener("click", () => {
        if (confirmationCallback) confirmationCallback();
      });
      newNoBtn.addEventListener("click", () => {
        if (noCallback) noCallback();
      });
      newCancelBtn.addEventListener("click", () => {
        if (cancelCallback) cancelCallback();
      });
    }

    function closeConfirmationModal() {
      document.getElementById("confirmationModal").classList.add("hidden");
      confirmationCallback = null;
      noCallback = null;
      cancelCallback = null;
    }

    document.addEventListener("keydown", function (event) {
      const confirmationModal = document.getElementById("confirmationModal");
      if (event.key === "Escape") {
        if (confirmationModal && !confirmationModal.classList.contains("hidden")) {
          closeConfirmationModal();
        }
        closeSavedGamesModal();
        closeSaveGameModal();
        closeFreezeGameModal();
      }
    });

    // Update global state
    function updateState(newState) {
      state = { ...state, ...newState };
      renderApp();
    }

    // Saved games modals
    function openSavedGamesModal() {
      renderSavedGames();
      renderFreezerGames();
      document.getElementById("savedGamesModal").classList.remove("hidden");
      document.getElementById("savedGamesModal").focus();
    }

    // Save game modal
    function openSaveGameModal() {
      document.getElementById("saveGameModal").classList.remove("hidden");
    }

    function closeSaveGameModal() {
      document.getElementById("saveGameModal").classList.add("hidden");
      document.getElementById("saveGameForm").reset();
    }

    // Freeze game modal
    function openFreezeGameModal() {
      document.getElementById("freezeGameModal").classList.remove("hidden");
    }

    function closeFreezeGameModal() {
      document.getElementById("freezeGameModal").classList.add("hidden");
      document.getElementById("freezeGameForm").reset();
    }

    // Bid & scoring logic
    function handleTeamClick(team) {
      if (state.gameOver) return;
      if (state.biddingTeam === team) {
        state.savedScoreInputStates[team] = {
          bidAmount: state.bidAmount,
          customBidValue: state.customBidValue,
          showCustomBid: state.showCustomBid,
          enterBidderPoints: state.enterBidderPoints,
          error: state.error
        };
        updateState({
          biddingTeam: "",
          bidAmount: "",
          showCustomBid: false,
          customBidValue: "",
          enterBidderPoints: false,
          error: ""
        });
      } else {
        const otherTeam = team === "us" ? "Dem" : "us";
        state.savedScoreInputStates[otherTeam] = null;
        let newState = {
          biddingTeam: team,
          bidAmount: "",
          showCustomBid: false,
          customBidValue: "",
          enterBidderPoints: false,
          error: ""
        };
        const savedState = state.savedScoreInputStates[team];
        if (savedState) {
          newState = { ...newState, ...savedState };
        }
        updateState(newState);
      }
      ephemeralCustomBid = "";
      ephemeralPoints = "";
    }

    function handleBidSelect(bid) {
      if (bid === "other") {
        ephemeralCustomBid = "";
        updateState({ showCustomBid: true, bidAmount: "", customBidValue: "" });
      } else {
        ephemeralCustomBid = "";
        updateState({ showCustomBid: false, bidAmount: bid.toString(), customBidValue: "" });
      }

      if (bid !== "other") {
        updateState({ lastBidAmount: bid.toString(), lastBidTeam: state.biddingTeam });
      } else {
        updateState({ lastBidAmount: null, lastBidTeam: null });
      }
    }

    function handleCustomBidChange(e) {
      ephemeralCustomBid = e.target.value;
      const err = validateBid(ephemeralCustomBid);
      if (err) {
        updateState({
          customBidValue: ephemeralCustomBid,
          bidAmount: "",
          lastBidAmount: null,
          lastBidTeam: null
        });
      } else {
        updateState({
          customBidValue: ephemeralCustomBid,
          bidAmount: ephemeralCustomBid,
          lastBidAmount: ephemeralCustomBid,
          lastBidTeam: state.biddingTeam
        });
      }
    }

    function handleBiddingPointsToggle(enterBidderPoints) {
      ephemeralPoints = "";
      updateState({ enterBidderPoints });
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const { biddingTeam, bidAmount, rounds, enterBidderPoints } = state;
      const pointsInput = document.getElementById("pointsInput");
      if (!pointsInput) {
        updateState({ error: "Points input field not found." });
        return;
      }
      const pointsValue = pointsInput.value;
      if (!biddingTeam || !bidAmount) {
        updateState({ error: "Please enter a custom bid" });
        return;
      }
      const bidError = validateBid(bidAmount);
      const pointsError = validatePoints(pointsValue);
      if (bidError || pointsError) {
        updateState({ error: bidError || pointsError });
        return;
      }

      const numericBid = Number(bidAmount);
      const numericPoints = Number(pointsValue);

      // if the bidding team tries for 360 points => the other team 0
      // otherwise total points in a round is always 180
      const pointsForBiddingTeam = enterBidderPoints
        ? numericPoints
        : (numericPoints === 360 ? 360 : 180 - numericPoints);
      const pointsForNonBiddingTeam = (numericPoints === 360)
        ? 0
        : 180 - pointsForBiddingTeam;

      // "us" is the bidding team
      const usPoints = biddingTeam === "us" ? pointsForBiddingTeam < numericBid ? -numericBid : pointsForBiddingTeam : pointsForNonBiddingTeam;
      const demPoints = biddingTeam === "Dem" ? pointsForBiddingTeam < numericBid ? -numericBid : pointsForBiddingTeam : pointsForNonBiddingTeam;

      const lastRunningTotals = rounds.length ? rounds[rounds.length - 1].runningTotals : { us: 0, Dem: 0 };
      const newRunningTotals = {
        us: lastRunningTotals.us + usPoints,
        Dem: lastRunningTotals.Dem + demPoints
      };
      const newRound = {
        biddingTeam,
        bidAmount: numericBid,
        usPoints,
        DemPoints: demPoints,
        runningTotals: newRunningTotals
      };
      const newRounds = [...rounds, newRound];

      // Check if game is over
      const biddingTeamSuccess = biddingTeam === "us" ? usPoints >= numericBid && usPoints > 0 : demPoints >= numericBid && demPoints > 0;
      const biddingTeamFail = biddingTeam === "us" ? demPoints < 0 : usPoints < 0;
      const spread = Math.abs(newRunningTotals.us - newRunningTotals.Dem);
      const leadingTeam = newRunningTotals.us > newRunningTotals.Dem ? "us" : "Dem";
      const thousandSpread = spread >= 1000;
      const forcedFail = biddingTeam === "us" ? usPoints < 0 : demPoints < 0;

      let gameOver = false;
      let winner = null;
      let reason = "";

      // Condition 1: Bidding team reached 500+ AND succeeded or forcibly ended it
      if (
        (biddingTeam === "us" && newRunningTotals.us >= 500 && (biddingTeamSuccess || biddingTeamFail)) ||
        (biddingTeam === "Dem" && newRunningTotals.Dem >= 500 && (biddingTeamSuccess || biddingTeamFail))
      ) {
        gameOver = true;
        winner = biddingTeam;
        reason = "reached 500 points";
      }
      // Condition 2: Bidding team failed, but the other team reached 500
      else if (forcedFail && (
        (biddingTeam === "us" && newRunningTotals.Dem >= 500) ||
        (biddingTeam === "Dem" && newRunningTotals.us >= 500)
      )) {
        gameOver = true;
        winner = biddingTeam === "us" ? "Dem" : "us";
        reason = `${biddingTeam === "us" ? "Dem" : "us"} reached 500 points after ${biddingTeam === "us" ? "our team" : "Dem team"} failed their bid`;
      }
      // Condition 3: 1000+ point spread
      else if (thousandSpread) {
        gameOver = true;
        winner = leadingTeam;
        reason = "a 1000-point spread";
      }

      ephemeralCustomBid = "";
      ephemeralPoints = "";

      if (gameOver) {
        updateState({
          rounds: newRounds,
          gameOver,
          winner,
          biddingTeam: "",
          bidAmount: "",
          showCustomBid: false,
          customBidValue: "",
          enterBidderPoints: false,
          error: ""
        });
        saveCurrentGameState();
      } else {
        updateState({
          rounds: newRounds,
          biddingTeam: "",
          bidAmount: "",
          showCustomBid: false,
          customBidValue: "",
          enterBidderPoints: false,
          error: ""
        });
        saveCurrentGameState();
      }
    }

    function handleUndo() {
      if (!state.rounds.length) return;
      const newRounds = state.rounds.slice(0, -1);
      let lastBidAmount = null;
      let lastBidTeam = null;
      if (newRounds.length > 0) {
        const lastRound = newRounds[newRounds.length - 1];
        lastBidAmount = lastRound.bidAmount.toString();
        lastBidTeam = lastRound.biddingTeam;
      }
      updateState({
        rounds: newRounds,
        gameOver: false,
        winner: null,
        lastBidAmount,
        lastBidTeam
      });
      saveCurrentGameState();
    }

    function handleNewGame() {
      if (state.rounds.length > 0) {
        openConfirmationModal(
          "Do you want to save the previous game result before starting a new game?",
          () => {
            closeConfirmationModal();
            openSaveGameModal();
          },
          () => {
            closeConfirmationModal();
            localStorage.removeItem(ACTIVE_GAME_KEY);
            ephemeralCustomBid = "";
            ephemeralPoints = "";
            updateState({ ...DEFAULT_STATE });
            confettiTriggered = false;
          },
          () => {
            closeConfirmationModal();
          }
        );
      } else {
        updateState({ ...DEFAULT_STATE });
      }
    }

    function handleManualSaveGame() {
      if (!state.rounds.length) return;
      openSaveGameModal();
    }

    // Freeze a game (move to freezerGames)
    function handleFreezeGameModalSubmit(freezeGameName) {
      if (!freezeGameName) return;
      const freezerGames = getLocalStorage("freezerGames");
      // Avoid duplicate names
      if (freezerGames.some(game => game.name.toLowerCase() === freezeGameName.toLowerCase())) return;

      const lastRound = state.rounds[state.rounds.length - 1];
      const finalScore = state.rounds.reduce((acc, round) => ({
        us: acc.us + round.usPoints,
        Dem: acc.Dem + round.DemPoints
      }), { us: 0, Dem: 0 });

      freezerGames.push({
        name: freezeGameName,
        finalScore,
        lastBid: lastRound.bidAmount,
        rounds: state.rounds,
        timestamp: new Date().toISOString()
      });
      setLocalStorage("freezerGames", freezerGames);

      // Clear the active game
      localStorage.removeItem(ACTIVE_GAME_KEY);
      ephemeralCustomBid = "";
      ephemeralPoints = "";
      updateState({ ...DEFAULT_STATE });
      confettiTriggered = false;
    }

    function handleFreezerGame() {
      if (!state.rounds.length) return;
      openFreezeGameModal();
    }

    // Save game form
    function handleSaveGameFormSubmit(e) {
      e.preventDefault();
      const player1Name = document.getElementById("player1Name").value.trim();
      const player2Name = document.getElementById("player2Name").value.trim();

      if (!player1Name || !player2Name) return;

      const finalScore = state.rounds.length
        ? state.rounds[state.rounds.length - 1].runningTotals
        : { us: 0, Dem: 0 };

      const savedGames = getLocalStorage("savedGames");
      savedGames.push({
        player1: player1Name,
        player2: player2Name,
        rounds: state.rounds,
        finalScore,
        timestamp: new Date().toISOString()
      });
      setLocalStorage("savedGames", savedGames);

      // Clear the active game
      localStorage.removeItem(ACTIVE_GAME_KEY);
      ephemeralCustomBid = "";
      ephemeralPoints = "";
      updateState({ ...DEFAULT_STATE });
      closeSaveGameModal();
      confettiTriggered = false;
    }

    // Freeze game form
    function handleFreezeGameFormSubmit(e) {
      e.preventDefault();
      const freezeGameName = document.getElementById("freezeGameName").value.trim();
      handleFreezeGameModalSubmit(freezeGameName);
      closeFreezeGameModal();
    }

    // Load freezer game
    function loadFreezerGame(index) {
      const freezerGames = getLocalStorage("freezerGames");
      const gameToLoad = freezerGames[index];
      if (!gameToLoad) return;

      openConfirmationModal(
        `Load the freezer game "${gameToLoad.name}"? This will overwrite the current game.`,
        () => {
          closeConfirmationModal();
          updateState({
            rounds: gameToLoad.rounds,
            gameOver: false,
            winner: null,
            biddingTeam: "",
            bidAmount: "",
            showCustomBid: false,
            customBidValue: "",
            enterBidderPoints: false,
            error: "",
            lastBidAmount: null,
            lastBidTeam: null
          });
          freezerGames.splice(index, 1);
          setLocalStorage("freezerGames", freezerGames);
          closeSavedGamesModal();
          saveCurrentGameState();
          confettiTriggered = false;
        },
        () => {
          closeConfirmationModal();
        },
        () => {
          closeConfirmationModal();
        }
      );
    }

    // Render saved games
    function renderSavedGames() {
      const savedGames = getLocalStorage("savedGames");
      const savedGamesList = document.getElementById("savedGamesList");
      if (!savedGames.length) {
        savedGamesList.innerHTML = '<p class="text-gray-600 dark:text-gray-300">No completed games available.</p>';
        return;
      }
      savedGamesList.innerHTML = savedGames.map((game, index) => `
        <div class="border p-4 rounded-xl shadow-sm bg-gray-50 dark:bg-gray-700">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-100">Players:</p>
              <p>${game.player1} vs ${game.player2}</p>
            </div>
            <button onclick="deleteSavedGame(${index})"
                    class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 dark:text-red-400 dark:hover:text-red-600"
                    aria-label="Delete Saved Game">
              ${Icons.Trash}
            </button>
          </div>
          <div class="mt-2">
            <p class="font-semibold text-gray-800 dark:text-gray-100">Final Score:</p>
            <p>Us: ${game.finalScore.us} | Dem: ${game.finalScore.Dem}</p>
          </div>
          <div class="mt-2">
            <p class="font-semibold text-gray-800 dark:text-gray-100">Date:</p>
            <p>${new Date(game.timestamp).toLocaleString()}</p>
          </div>
        </div>
      `).join("");
    }

    // Render freezer games
    function renderFreezerGames() {
      const freezerGames = getLocalStorage("freezerGames");
      const freezerGamesList = document.getElementById("freezerGamesList");
      if (!freezerGames.length) {
        freezerGamesList.innerHTML = '<p class="text-gray-600 dark:text-gray-300">No freezer games available.</p>';
        return;
      }
      freezerGamesList.innerHTML = freezerGames.map((game, index) => `
        <div class="border p-4 rounded-xl shadow-sm bg-gray-50 dark:bg-gray-700">
          <div class="flex justify-between items-center">
            <div>
              <p class="font-semibold text-gray-800 dark:text-gray-100">Name:</p>
              <p>${game.name}</p>
            </div>
            <div class="flex space-x-2">
              <button onclick="loadFreezerGame(${index})"
                      class="text-blue-600 hover:text-blue-800 flex items-center focus:outline-none focus:ring-2 focus:ring-blue-500 dark:text-blue-400 dark:hover:text-blue-600"
                      aria-label="Load Freezer Game">
                ${Icons.Load}Load
              </button>
              <button onclick="deleteFreezerGame(${index})"
                      class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 dark:text-red-400 dark:hover:text-red-600"
                      aria-label="Delete Freezer Game">
                ${Icons.Trash}
              </button>
            </div>
          </div>
          <div class="mt-2">
            <p class="font-semibold text-gray-800 dark:text-gray-100">Final Score:</p>
            <p>Us: ${game.finalScore.us} | Dem: ${game.finalScore.Dem}</p>
          </div>
          <div class="mt-2">
            <p class="font-semibold text-gray-800 dark:text-gray-100">Last Bid:</p>
            <p>${game.lastBid}</p>
          </div>
          <div class="mt-2">
            <p class="font-semibold text-gray-800 dark:text-gray-100">Date Frozen:</p>
            <p>${new Date(game.timestamp).toLocaleString()}</p>
          </div>
        </div>
      `).join("");
    }

    // Helper function for deleting saved/freezer games
    function deleteSavedGame(index) {
      deleteGame("savedGames", index, "saved game");
    }
    function deleteFreezerGame(index) {
      deleteGame("freezerGames", index, "freezer game");
    }

    // Render helpers
    function renderTeamCard(team, points, color) {
      const isSelected = (state.biddingTeam === team);
      const baseColor = isSelected ? `bg-${color}-900 text-white` : `bg-${color}-500 text-white`;
      return `
        <div class="${baseColor} cursor-pointer hover:${baseColor} transition-colors rounded-xl shadow-md flex items-center justify-center w-32 h-32"
             onclick="handleTeamClick('${team}')"
             tabindex="0" role="button" aria-pressed="${isSelected}"
             aria-label="Select ${team === "us" ? "Our Team" : "Dem Team"}">
          <div class="flex flex-col items-center">
            <h2 class="text-xl font-semibold capitalize">${team === "us" ? "Us" : "Dem"}</h2>
            <p class="text-2xl font-bold">${points}</p>
          </div>
        </div>
      `;
    }

    function renderRoundCard(roundNumber, lastBidMarkup) {
      return `
        <div class="bg-white rounded-xl border border-gray-200 shadow flex flex-col items-center justify-center p-4 flex-1 min-w-0 w-48 h-32 dark:bg-gray-800 dark:border-gray-700">
          <div class="text-center space-y-1">
            <h2 class="text-xl font-bold text-gray-700 dark:text-gray-100">Round</h2>
            <p class="text-2xl font-extrabold text-gray-900 dark:text-gray-100">${roundNumber}</p>
            ${lastBidMarkup}
          </div>
        </div>
      `;
    }

    function renderErrorAlert(errorText) {
      return `
        <div role="alert" class="flex items-center border border-red-400 rounded-xl p-4 bg-red-50 text-red-700 space-x-3 dark:bg-red-700 dark:border-red-600 dark:text-red-100">
          <div class="flex-shrink-0">${Icons.AlertCircle}</div>
          <div class="flex-1">${errorText}</div>
        </div>
      `;
    }

    function renderPointsInput() {
      const { biddingTeam, enterBidderPoints } = state;
      const labelText = biddingTeam === "us"
        ? (enterBidderPoints ? "Our Points (Bidding Team)" : "Dem Points (Non-Bidding Team)")
        : (enterBidderPoints ? "Dem Points (Bidding Team)" : "Our Points (Non-Bidding Team)");
      const biddingColor = (biddingTeam === "Dem") ? "red" : "blue";
      const nonBiddingColor = (biddingTeam !== "Dem") ? "red" : "blue";

      const biddingButtonClass = enterBidderPoints
        ? `bg-${biddingColor}-600 text-white shadow hover:bg-${biddingColor}-700 dark:bg-${biddingColor}-700 dark:hover:bg-${biddingColor}-800`
        : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500`;
      const nonBiddingButtonClass = !enterBidderPoints
        ? `bg-${nonBiddingColor}-600 text-white shadow hover:bg-${nonBiddingColor}-700 dark:bg-${nonBiddingColor}-700 dark:hover:bg-${nonBiddingColor}-800`
        : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500`;

      return `
        <div class="space-y-6">
          <div>
            <label for="pointsToggle" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">Enter Points For</label>
            <div class="flex gap-4">
              <button type="button"
                      class="flex-1 rounded-full px-4 py-2 text-sm font-medium ${biddingButtonClass} transition focus:outline-none focus:ring-2 focus:ring-${biddingColor}-500 focus:ring-opacity-50"
                      onclick="handleBiddingPointsToggle(true)" aria-pressed="${enterBidderPoints}">
                Bidding Team
              </button>
              <button type="button"
                      class="flex-1 rounded-full px-4 py-2 text-sm font-medium ${nonBiddingButtonClass} transition focus:outline-none focus:ring-2 focus:ring-${nonBiddingColor}-500 focus:ring-opacity-50"
                      onclick="handleBiddingPointsToggle(false)" aria-pressed="${!enterBidderPoints}">
                Non-Bidding Team
              </button>
            </div>
          </div>
          <div>
            <label for="pointsInput" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">${labelText}</label>
            <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
              <input id="pointsInput" type="number" inputmode="numeric" pattern="[0-9]*" min="0" max="360"
                     placeholder="Enter points"
                     class="w-full sm:w-1/2 border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100 dark:focus:ring-blue-400"
                     aria-label="Enter Points" />
              <button type="submit"
                      class="mt-4 sm:mt-0 bg-blue-600 text-white px-6 py-2 rounded-xl shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400">
                Submit
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderScoreInputCard() {
      const { biddingTeam, bidAmount, customBidValue, showCustomBid, rounds, gameOver } = state;
      if (gameOver || !biddingTeam) return "";

      const hasBid = bidAmount || showCustomBid;
      return `
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg dark:bg-gray-800 dark:border-gray-700">
          <div class="border-b border-gray-200 p-5 flex justify-between items-center dark:border-gray-700">
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100">Score Input for ${biddingTeam === "us" ? "Our Team" : "Dem Team"}</h2>
            <button class="flex items-center border border-gray-300 rounded px-3 py-2 text-sm text-gray-700 hover:bg-gray-200 transition disabled:opacity-50 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:text-gray-200 dark:hover:bg-gray-700 dark:focus:ring-blue-400"
                    onclick="handleUndo(event)"
                    ${!rounds.length ? "disabled" : ""}
                    title="Undo Last Round"
                    aria-label="Undo Last Round">
              ${Icons.Undo}Undo
            </button>
          </div>
          <div class="p-6 score-input-container ${biddingTeam ? "show" : ""}">
            <form onsubmit="handleFormSubmit(event)" class="space-y-6">
              <div>
                <label for="bidAmount" class="block text-sm font-medium mb-2 text-gray-700 dark:text-gray-200">Bid Amount</label>
                <div class="flex flex-wrap gap-3">
                  ${presetBids.map(b => {
                    const isActive = (b === "other") ? showCustomBid : bidAmount === String(b);
                    const buttonClass = isActive
                      ? "bg-blue-600 text-white shadow hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700"
                      : "bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-200 dark:hover:bg-gray-500";
                    const shapeClass = (b === "other") ? "rounded-full" : "rounded-lg";
                    return `
                      <button type="button"
                              class="px-4 py-2 text-sm font-medium ${buttonClass} ${shapeClass} transition focus:outline-none focus:ring-2 focus:ring-blue-500 dark:ring-blue-400"
                              onclick="handleBidSelect('${b}')"
                              aria-pressed="${isActive}"
                              aria-label="Select Bid ${b === "other" ? "Other" : b}">
                        ${b === "other" ? "Other" : b}
                      </button>
                    `;
                  }).join("")}
                  ${
                    showCustomBid
                      ? `
                        <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:gap-4">
                          <input type="number"
                                 inputmode="numeric"
                                 pattern="[0-9]*"
                                 step="5"
                                 value="${customBidValue}"
                                 onchange="handleCustomBidChange(event)"
                                 placeholder="Enter custom bid"
                                 class="w-full sm:w-1/2 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-gray-600 dark:border-gray-500 dark:text-gray-100 dark:focus:ring-blue-400"
                                 aria-label="Custom Bid Amount" />
                          <span class="text-sm text-gray-500 dark:text-gray-300">Must be divisible by 5 (≤180 or 360)</span>
                        </div>
                      `
                      : ""
                  }
                </div>
              </div>
              ${hasBid ? renderPointsInput() : ""}
            </form>
          </div>
        </div>
      `;
    }

    function renderHistoryCard() {
      const { rounds } = state;
      return `
        <div class="bg-white border border-gray-200 rounded-xl shadow dark:bg-gray-800 dark:border-gray-700">
          <div class="border-b border-gray-200 p-4 dark:border-gray-700">
            <h2 class="text-lg font-bold text-gray-800 dark:text-gray-100">History</h2>
            <div class="grid grid-cols-3 gap-2 pt-3 font-medium text-gray-600 dark:text-gray-300 text-sm sm:text-base">
              <div class="text-left">Us</div>
              <div class="text-center">Bid</div>
              <div class="text-right">Dem</div>
            </div>
          </div>
          <div class="p-4">
            <div class="space-y-2">
              ${
                rounds.map((round, index) => {
                  const arrow = round.biddingTeam === "us"
                    ? `<span class="text-gray-800 dark:text-gray-100">←</span><span class="ml-1">${round.bidAmount}</span>`
                    : `<span class="mr-1">${round.bidAmount}</span><span class="text-gray-800 dark:text-gray-100">→</span>`;
                  return `
                    <div key="${index}" class="grid grid-cols-3 gap-2 p-2 bg-gray-50 rounded-xl dark:bg-gray-700">
                      <div class="text-left text-gray-800 dark:text-gray-100 font-semibold">${round.runningTotals.us}</div>
                      <div class="flex items-center justify-center">${arrow}</div>
                      <div class="text-right text-gray-800 dark:text-gray-100 font-semibold">${round.runningTotals.Dem}</div>
                    </div>
                  `;
                }).join("")
              }
            </div>
          </div>
        </div>
      `;
    }

    function renderGameOverOverlay() {
      if (!state.gameOver) return "";
      const { winner } = state;
      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center p-4" role="alertdialog" aria-labelledby="gameOverTitle" aria-modal="true">
          <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800">
            <div class="p-6 text-center">
              <h2 id="gameOverTitle" class="text-3xl font-bold mb-4 animate-fade-in text-gray-800 dark:text-gray-100 flex items-center justify-center">
                ${Icons.Trophy}Game Over!
              </h2>
              <p class="text-xl mb-6 animate-fade-in text-gray-700 dark:text-gray-300">
                ${winner === "us" ? "Our Team Wins!" : "Dem Team Wins!"}
              </p>
              <button onclick="handleNewGame()" class="bg-blue-600 text-white px-6 py-3 rounded-xl shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400">New Game</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const { error, rounds, lastBidAmount, lastBidTeam, gameOver } = state;
      const totals = rounds.reduce(
        (acc, round) => ({
          us: acc.us + round.usPoints,
          Dem: acc.Dem + round.DemPoints
        }),
        { us: 0, Dem: 0 }
      );
      const nextRoundNumber = rounds.length + 1;

      let lastBidMarkup = "";
      if (lastBidAmount && lastBidTeam) {
        const arrow = (lastBidTeam === "us") ? "←" : "→";
        lastBidMarkup = `
          <div class="mt-2 flex items-center justify-center space-x-1 text-gray-700 dark:text-gray-300">
            <span class="font-medium">Bid:</span>
            <span>${lastBidAmount}</span>
            <span>${arrow}</span>
          </div>
        `;
      }

      document.getElementById("app").innerHTML = `
        <div class="text-center space-y-2">
          <div class="flex flex-col items-center">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 dark:text-gray-100">Rook!</h1>
          </div>
          <p class="text-md sm:text-lg text-gray-600 dark:text-gray-300">Tap a team to start a bid!</p>
        </div>
        <div class="flex flex-row space-x-4 flex-wrap justify-center">
          ${renderTeamCard("us", totals.us, "blue")}
          ${renderRoundCard(nextRoundNumber, lastBidMarkup)}
          ${renderTeamCard("Dem", totals.Dem, "red")}
        </div>
        ${error ? `<div>${renderErrorAlert(error)}</div>` : ""}
        ${renderScoreInputCard()}
        ${renderHistoryCard()}
        ${renderGameOverOverlay()}
      `;

      if (gameOver && !confettiTriggered) {
        confettiTriggered = true;
        confetti({
          particleCount: 200,
          spread: 70,
          origin: { y: 0.6 }
        });
      }
    }

    function validateBid(value) {
      const num = Number(value);
      if (isNaN(num)) return "Bid must be a number.";
      if (num <= 0) return "Bid must be greater than zero.";
      if (num % 5 !== 0) return "Bid must be divisible by 5.";
      if (num > 360) return "Bid cannot exceed 360.";
      return "";
    }

    function validatePoints(value) {
      const num = Number(value);
      if (isNaN(num)) return "Points must be a number.";
      if (num < 0 || num > 360) return "Points must be between 0 and 360.";
      return "";
    }

    function showEasterEgg() {
      alert("Added Dark Mode functionallity, fixed logic bugs, improved user experience, increased efficiency");
    }

    document.addEventListener("DOMContentLoaded", () => {
      const closeSavedGamesModalBtn = document.getElementById("closeSavedGamesModalBtn");
      if (closeSavedGamesModalBtn) {
        closeSavedGamesModalBtn.addEventListener("click", closeSavedGamesModal);
      }
      const saveGameForm = document.getElementById("saveGameForm");
      if (saveGameForm) {
        saveGameForm.addEventListener("submit", handleSaveGameFormSubmit);
      }
      const freezeGameForm = document.getElementById("freezeGameForm");
      if (freezeGameForm) {
        freezeGameForm.addEventListener("submit", handleFreezeGameFormSubmit);
      }

      loadCurrentGameState();
      initializeDarkMode();
      renderApp();
    });

    // -------------------------------------------
    // Service Worker Registration (Add this block)
    // -------------------------------------------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('service-worker.js')
          .then(reg => {
            console.log('Service Worker registered! Scope:', reg.scope);
          })
          .catch(err => {
            console.error('Service Worker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
