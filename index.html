<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Rook Score Taking</title>
    <link rel="manifest" href="manifest.json" /> <!-- Kept for PWA functionality -->
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="icon" href="icons/icon-192x192.png" /> <!-- Kept for PWA functionality -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
      :root {
        --primary-color: #3b82f6;
        --accent-color: #ef4444;
      }
      body.modal-open {
        overflow: hidden;
      }
      .modal-open .hamburger-menu {
        display: none;
      }

      /* Custom Input Type Color Styling */
      input[type="color"] {
        -webkit-appearance: none;
        appearance: none;
        border: 2px solid #ccc;
        width: 80px; /* Maintained from original */
        height: 50px; /* Maintained from original */
        padding: 0;
        border-radius: 6px;
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
      }
      input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 6px; /* Match outer radius */
      }
      input[type="color"]:hover,
      input[type="color"]:focus {
        border-color: var(--primary-color); /* Use theme color */
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      }

      /* Animations */
      @keyframes fadeInElement {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOutElement {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(5px); }
      }
      .animate-fadeIn {
        animation: fadeInElement 0.1s ease-in-out forwards;
      }
      .animate-fadeOut {
        animation: fadeOutElement 0.15s ease-in-out forwards;
      }

      .score-input-container {
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transform: translateY(-10px);
        transition:
          max-height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
          opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1),
          transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .score-input-container.show {
        max-height: 1000px; /* Ensure enough space */
        opacity: 1;
        transform: translateY(0);
      }

      /* Tailwind Overrides / Custom Utilities - Keep if they are intentional overrides */
      .rounded-xl { border-radius: 0.75rem !important; }
      .shadow-sm { box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important; }
      .shadow { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important; }
      .shadow-md { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important; }
      .shadow-lg { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important; }
      .dark .text-gray-800 { color: #ffffff !important; }

      /* Hamburger Menu */
      .hamburger-menu {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 30px;
        height: 24px;
        cursor: pointer;
        z-index: 1300;
        transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .hamburger-menu:hover {
        transform: scale(1.1);
      }
      .hamburger-menu:focus-visible { /* Standard focus outline for accessibility */
        outline: 2px solid #3b82f6; /* Tailwind's blue-500 */
        outline-offset: 2px;
      }
      .bar {
        position: absolute;
        width: 30px;
        height: 3px;
        background-color: #333; /* Default bar color */
        transition:
          transform 0.25s cubic-bezier(0.25, 0.8, 0.25, 1),
          opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
          background-color 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        transform-origin: center;
      }
      .bar:nth-child(1) { top: 0; }
      .bar:nth-child(2) { top: 10px; }
      .bar:nth-child(3) { top: 20px; }
      html.dark .bar {
        background-color: #fff; /* Bar color in dark mode */
      }
      .hamburger-menu.open .bar:nth-child(1) { transform: rotate(45deg) translate(5px, 9px); }
      .hamburger-menu.open .bar:nth-child(2) { transform: rotate(45deg) translate(-2px, 2px); }
      .hamburger-menu.open .bar:nth-child(3) { transform: rotate(-45deg) translate(5px, -9px); }

      /* Navigation Menu */
      nav {
        position: fixed;
        top: 0;
        left: -300px; /* Hidden by default */
        width: 280px;
        height: 100%;
        background-color: #fff;
        z-index: 1200;
        transition: left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        border-top-right-radius: 0.75rem;
        border-bottom-right-radius: 0.75rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      nav.show {
        left: 0; /* Shown */
      }
      html.dark nav {
        background-color: #2d3748; /* dark:bg-gray-700 equivalent */
      }
      nav ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
        margin-top: 60px; /* Space for hamburger icon */
      }
      nav ul li {
        margin: 0;
        border-bottom: 1px solid #e0e0e0; /* Light mode border */
      }
      html.dark nav ul li {
        border-bottom: 1px solid #4a5568; /* Dark mode border, dark:border-gray-600 */
      }
      nav ul li:last-child {
        border-bottom: none;
      }
      nav ul li a,
      nav ul li button,
      nav ul li label { /* Added label for dark mode toggle consistency */
        color: #333;
        text-decoration: none;
        font-size: 20px;
        padding: 15px 20px;
        display: block;
        transition: background-color 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        width: 100%;
        text-align: left;
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
      }
      nav ul li a:hover,
      nav ul li button:hover,
      nav ul li label:hover { /* Added label for dark mode toggle consistency */
        background-color: #f5f5f5; /* Light mode hover */
        filter: brightness(0.97);
      }
      html.dark nav ul li a,
      html.dark nav ul li button,
      html.dark nav ul li label { /* Added label for dark mode toggle consistency */
        color: #fff;
      }
      html.dark nav ul li a:hover,
      html.dark nav ul li button:hover,
      html.dark nav ul li label:hover { /* Added label for dark mode toggle consistency */
        background-color: #4a5568; /* Dark mode hover, dark:bg-gray-600 */
        filter: brightness(0.95);
      }
      /* Removed .close-menu as it wasn't in the markup */
      .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1150;
        display: none;
      }
      .menu-overlay.show {
        display: block;
      }

      /* Modal Styling */
      .modal {
        opacity: 0;
        transform: scale(0.95);
        transition:
          transform 0.25s cubic-bezier(0.25, 0.8, 0.25, 1),
          opacity 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .modal.hidden {
        display: none;
      }
      .modal:not(.hidden) {
        opacity: 1;
        transform: scale(1);
      }
      .modal > div { /* Styling for the direct child (content box) of a modal */
        margin: 1rem auto; /* Centering and spacing */
        max-height: calc(100vh - 2rem); /* Prevent overflow */
      }
      #confirmationModal { /* Ensure confirmation modal is on top */
        z-index: 9999;
      }
      #savedGamesModal { /* Ensure saved games modal z-index for backdrop-blur */
         z-index: 9990; /* Slightly lower than confirmation, but above others */
      }
       #themeModal {
        z-index: 9995; /* Above savedGames, below confirmation */
      }
      #teamSelectionModal {
        z-index: 9998;   /* anything > 49 is fine; keep it below #confirmationModal (9999) */
      }
      #viewSavedGameModal {
        z-index: 9996; /* Above savedGamesModal and themeModal, below teamSelection and confirmation */
      }


      /* Scrollbar Hiding */
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

      /* Save Indicator */
      #saveIndicator {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background-color: rgba(16, 185, 129, 0.7); /* Tailwind green-500 with opacity */
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* shadow-md */
        opacity: 0;
        transform: translateY(20px) scale(0.9);
        transition:
          opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
          transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        pointer-events: none;
        z-index: 1000;
        font-size: 0.875rem; /* text-sm */
      }
      #saveIndicator.show {
        opacity: 1;
        transform: translateY(0) scale(1);
      }

      /* 3D Button Effect & Sunken Selection */
      .threed {
        transition:
          box-shadow 0.2s cubic-bezier(0.25, 0.8, 0.25, 1),
          transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .threed:hover,
      .threed:focus { /* Combined hover and focus */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      .threed:active {
        transform: scale(0.97);
      }
      .sunken-selected {
        border-radius: inherit; /* Use parent's border-radius */
        position: relative;
        box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.6) !important; /* Ensure this shadow applies */
      }
      .sunken-selected::after {
        border-radius: inherit;
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.414);
        pointer-events: none;
        z-index: auto; /* Let browser decide or set explicitly if needed */
      }
      .sunken-selected > * { /* Ensure children are above the overlay */
        border-radius: inherit;
        position: relative;
        z-index: 1;
      }

      /* Theming with CSS Variables */
      .bg-primary {
        background-color: var(--primary-color) !important;
        transition:
          background-color 0.25s cubic-bezier(0.25, 0.8, 0.25, 1),
          filter 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .bg-primary:hover { filter: brightness(0.95); }
      .bg-accent {
        background-color: var(--accent-color) !important;
        transition:
          background-color 0.25s cubic-bezier(0.25, 0.8, 0.25, 1),
          filter 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .bg-accent:hover { filter: brightness(0.95); }
      .text-primary { color: var(--primary-color) !important; }
      .text-accent { color: var(--accent-color) !important; }

      /* Input Focus Styling */
      input[type="text"]:focus,
      input[type="number"]:focus,
      select:focus,
      textarea:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
        transition: outline 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      button:focus-visible { /* More specific for buttons to avoid overriding all focus */
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }
      /* Dark mode inputs */
      .dark input,
      .dark select,
      .dark textarea {
        background-color: #4a5568; /* dark:bg-gray-600 equivalent */
        color: #fff;
      }
      .dark input::placeholder,
      .dark textarea::placeholder {
          color: #a0aec0; /* dark:placeholder-gray-400 */
      }


      /* Typography */
      h1 {
        font-size: clamp(1.75rem, 5vw, 3rem); /* Responsive H1 */
      }
      #app.modal-active {
        filter: blur(3px) grayscale(0.2) brightness(0.7);
        pointer-events: none;
        user-select: none;
        transition: filter 0.2s;
      }
    </style>
</head>
<body class="bg-white text-gray-800 min-h-screen transition-colors duration-300 dark:bg-gray-900 dark:text-white theme-blue-red" id="bodyRoot">
    <!-- Hamburger Icon -->
    <div class="hamburger-menu" onclick="toggleMenu(event)" aria-label="Open Menu" role="button" tabindex="0" id="hamburgerIcon">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>

    <!-- Navigation Menu -->
    <nav id="menu">
      <ul>
        <li><button type="button" onclick="openSavedGamesModal(); toggleMenu(event);">View Games</button></li>
        <li><button type="button" onclick="handleNewGame(); toggleMenu(event);">New Game</button></li>
        <li><button type="button" onclick="handleFreezerGame(); toggleMenu(event);">Freeze Game</button></li>
        <li><button type="button" onclick="openSettingsModal(); toggleMenu(event);">Settings</button></li>
        <li><button type="button" onclick="openAboutModal(); toggleMenu(event);">About</button></li>
        <li><button type="button" onclick="openStatisticsModal(); toggleMenu(event);">Statistics</button></li>
        <li>
          <label for="darkModeToggle" class="flex items-center justify-between w-full cursor-pointer">
            <span>Dark Mode</span>
            <div class="relative">
              <input type="checkbox" id="darkModeToggle" class="sr-only peer" />
              <div class="w-14 h-7 bg-gray-200 rounded-full dark:bg-gray-700
                          peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500
                          peer-checked:bg-blue-600 dark:peer-checked:bg-blue-500
                          after:content-[''] after:absolute after:top-0.5 after:left-0.5
                          after:bg-white after:border after:border-gray-300 after:rounded-full
                          after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7 cursor-pointer">
              </div>
            </div>
          </label>
        </li>
        <li id="authMenuItem">
            <button
              id="googleAuthBtn"
              onclick="(window.firebaseAuth && window.firebaseAuth.currentUser && !window.firebaseAuth.currentUser.isAnonymous) ? signOutUser() : signInWithGoogle(); toggleMenu(event)"
              class="flex items-center justify-between w-full"
              aria-label="Toggle Authentication"
              type="button">
              <div class="flex items-center space-x-3">
                <span class="bg-white p-1 rounded shadow-sm flex items-center justify-center">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C4.01 20.07 7.77 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.77 1 4.01 3.93 2.18 7.07L5.84 9.91c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                  </svg>
                </span>
                <span id="authLabel" class="truncate">Sign in with Google</span>
              </div>
            </button>
          </li>
      </ul>
    </nav>
    <div id="menuOverlay" class="menu-overlay" onclick="closeMenuOverlay()" aria-hidden="true"></div>

    <!-- Version Number -->
    <div class="absolute top-0 right-0 m-4 p-2 text-gray-800 font-medium text-xs bg-white bg-opacity-70 rounded shadow px-3 py-1 dark:bg-gray-800 dark:text-white cursor-pointer" onclick="showVersionNum()">
      <p>version 1.4.5</p>
    </div>

    <!-- Main App Container -->
    <main id="app" class="max-w-4xl mx-auto p-2 sm:p-4 space-y-3"></main>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="hidden">Saved</div>

    <!-- Saved Games Modal -->
    <div id="savedGamesModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-4 modal" role="dialog" aria-modal="true" aria-labelledby="savedGamesTitle">
      <div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden dark:bg-gray-800 flex flex-col" style="max-height: 85vh;">
        <header class="border-b border-gray-200 dark:border-gray-700">
          <div class="flex justify-between items-center px-6 pt-5 pb-2">
            <h3 id="savedGamesTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Game Library</h3>
            <button id="closeSavedGamesModalBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-lg p-1 transition-colors dark:text-gray-400 dark:hover:text-white" aria-label="Close Saved Games Modal" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>
          <div class="flex px-6">
            <button id="completedGamesTab" class="py-3 px-4 border-b-2 border-blue-600 text-blue-600 font-medium dark:text-blue-400 dark:border-blue-400 relative" onclick="switchGamesTab('completed')">
              Completed Games
              <span class="absolute top-0 right-0 transform translate-x-1/3 -translate-y-1/2 bg-blue-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" id="completedGamesCount">0</span>
            </button>
            <button id="freezerGamesTab" class="py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium dark:text-gray-400 dark:hover:text-gray-300 relative" onclick="switchGamesTab('freezer')">
              Freezer Games
              <span class="absolute top-0 right-0 transform translate-x-1/3 -translate-y-1/2 bg-gray-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" id="freezerGamesCount">0</span>
            </button>
          </div>
        </header>
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 flex flex-col sm:flex-row gap-3">
          <div class="relative flex-grow">
            <input type="text" id="gameSearchInput" placeholder="Search games..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:border-gray-500 dark:text-white dark:focus:ring-blue-400" oninput="filterGames()" />
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
          </div>
          <div class="sm:w-40">
            <select id="gameSortSelect" class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-600 dark:border-gray-500 dark:text-white dark:focus:ring-blue-400" onchange="sortGames()">
              <option value="newest">Newest First</option><option value="oldest">Oldest First</option><option value="highest">Highest Score</option><option value="lowest">Lowest Score</option>
            </select>
          </div>
        </div>
        <div class="flex-grow overflow-y-auto min-h-0 p-6 bg-white dark:bg-gray-800">
          <section id="completedGamesSection" class="space-y-4">
            <div id="savedGamesList" class="grid grid-cols-1 gap-4"></div>
            <div id="noCompletedGamesMessage" class="hidden py-8 text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
              <p class="mt-2 text-gray-600 dark:text-gray-400">No completed games found</p>
              <button onclick="handleNewGame(); closeMenuOverlay(); closeSavedGamesModal();" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Start a New Game</button>
            </div>
          </section>
          <section id="freezerGamesSection" class="space-y-4 hidden">
            <div id="freezerGamesList" class="grid grid-cols-1 gap-4"></div>
            <div id="noFreezerGamesMessage" class="hidden py-8 text-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
              <p class="mt-2 text-gray-600 dark:text-gray-400">No freezer games found</p>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-500">Freeze a game to continue it later</p>
            </div>
          </section>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4 modal transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="confirmationModalTitle">
      <div class="bg-white w-full max-w-md rounded-2xl shadow-xl dark:bg-gray-800 transform transition-all duration-300 scale-100">
        <div class="p-6 space-y-6">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h2 id="confirmationModalTitle" class="text-2xl font-semibold text-gray-900 dark:text-white">Confirm Action</h2>
          </div>
          <p id="confirmationModalMessage" class="text-base text-gray-600 dark:text-gray-300">Are you sure you want to proceed?</p>
          <div class="flex justify-end items-center space-x-3">
            <button type="button" id="noModalButton" class="px-4 py-2.5 rounded-xl bg-gray-100 text-gray-700 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 font-medium">Cancel</button>
            <button type="button" id="confirmModalButton" class="px-4 py-2.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors duration-200 font-medium">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- View Saved Game Modal -->
    <div id="viewSavedGameModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden flex items-center justify-center p-2 sm:p-4 modal" role="dialog" aria-modal="true" aria-labelledby="viewSavedGameTitle">
      <div class="bg-white w-full max-w-4xl rounded-xl shadow-lg overflow-hidden dark:bg-gray-800 max-h-[95vh] sm:max-h-[90vh] flex flex-col">
        <header class="flex justify-between items-center p-4 sm:p-5 border-b border-gray-200 dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
          <h3 id="viewSavedGameTitle" class="text-xl sm:text-2xl font-semibold text-gray-800 dark:text-white">Game Details</h3>
          <button id="closeViewSavedGameModalBtn" class="text-gray-700 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 p-1 rounded-lg dark:text-white dark:hover:text-gray-300" aria-label="Close View Saved Game Modal" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </header>
        <div id="viewSavedGameDetails" class="p-4 sm:p-5 space-y-6 overflow-y-auto flex-grow"></div>
      </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 modal" role="dialog" aria-modal="true" aria-labelledby="aboutModalTitle" style="-webkit-overflow-scrolling: touch;">
      <div class="relative mx-auto my-8 w-full max-w-4xl bg-white rounded-xl shadow-lg dark:bg-gray-800 overflow-hidden" style="max-height: 80vh;">
        <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 0px); /* Adjust if header/footer added */">
          <header class="flex justify-between items-center mb-6">
            <h2 id="aboutModalTitle" class="text-3xl font-bold text-gray-800 dark:text-white">About Rook Score!</h2>
            <button type="button" onclick="closeAboutModal()" class="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded-full dark:text-gray-400 dark:hover:text-white" aria-label="Close About Modal">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </header>
          <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 shadow-sm">
              <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>Quick Start</h3>
              <p class="text-gray-700 dark:text-gray-200">Tap a team ('Us' or 'Dem') to start. Select or enter bid, choose points team, input points, and submit. Scores update, history appears.</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 shadow-sm">
              <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>Pro Feature</h3>
              <ul class="list-disc list-inside text-gray-700 dark:text-gray-200 space-y-1"><li>Win probability display.</li></ul>
            </div>
          </section>
          <section class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 shadow-sm mb-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>Key Features</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Effortless Scoring</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Game History</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Save & Load Games</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Cloud Sync</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Team Statistics</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Customizable Themes</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Dark Mode</span></div>
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200">Win Probability</span></div>
              <!-- Table-talk/cheating penalty feature -->
              <div class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-blue-600 dark:text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2 text-gray-700 dark:text-gray-200"><strong>Table-Talk Penalty:</strong> Flag a team for table-talk (cheating) during a round. The flagged team will automatically lose their bid for that hand.</span></div>
            </div>
          </section>
          <section class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 shadow-sm mb-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>What's New in v1.4.5</h3>
            <ul class="space-y-2 text-gray-700 dark:text-gray-200">
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Improved 0-Point Handling:</strong> Added a smart popup to confirm if a 0-point team should trigger a 180 or 360-point bonus to the bidding team.</span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Table-Talk Feature:</strong> New "Table-Talk" button lets you remove the bid from offending team</span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Pro Mode:</strong> Unlock win probability.</span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Sandbagger Stat.</strong></span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Settings Button:</strong> Access game rules, Pro Mode, theme color customization, and bid presets from the new settings menu.</span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>Settings Explained:</strong> 
                <ul class='list-disc list-inside ml-4'>
                  <li><strong>Game Rules:</strong> Toggle "Must win by making bid" to require the bidder to make their bid to win, even if over 500 points.</li>
                  <li><strong>Pro Mode:</strong> Enable to show win probability during games.</li>
                  <li><strong>Customize Theme Colors:</strong> Personalize team colors for "Us" and "Dem".</li>
                  <li><strong>Edit Bid Presets:</strong> Change the quick bid buttons to your preferred values.</li>
                </ul>
              </span></li>
              <li class="flex items-start"><div class="flex-shrink-0 h-5 w-5 text-green-600 dark:text-green-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div><span class="ml-2"><strong>UI Overhaul:</strong> Major visual and usability improvements throughout the app for a cleaner, more modern experience.</span></li>
            </ul>
          </section>
          <section class="bg-yellow-50 dark:bg-gray-700 rounded-xl p-5 shadow-sm mb-6">
            <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-600 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0zM4.93 4.93l1.07 1.07M18 18l1.07 1.07M4.93 19.07l1.07-1.07M18 6l1.07-1.07M12 2a10 10 0 100 20 10 10 0 000-20zM12 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM12 6a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"/></svg>Report an Issue</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-4 text-sm">Found a problem? Click below to open an email draft with debug info. Please describe the issue.</p>
            <button type="button" onclick="handleBugReportClick()" class="w-full bg-yellow-500 text-white px-4 py-2.5 rounded-xl hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 dark:focus:ring-yellow-400 transition-colors duration-200 font-medium threed flex items-center justify-center shadow-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>Create Bug Report Email</button>
          </section>
          <footer class="flex justify-between items-center">
            <div class="flex items-center space-x-2">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A9 9 0 1112 21a9 9 0 01-6.879-3.196z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </span>
              <span class="px-3 py-1 rounded-full bg-blue-50 dark:bg-blue-800 text-blue-700 dark:text-blue-200 font-semibold text-sm shadow-sm border border-blue-200 dark:border-blue-700">
                Author: Mark Heinonen
              </span>
            </div>
            <button type="button" onclick="closeAboutModal()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-xl hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-500 threed">Close</button>
          </footer>
        </div>
      </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statisticsModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden overflow-y-auto z-50 modal flex items-center justify-center" role="dialog" aria-modal="true" aria-labelledby="statisticsModalTitle" style="-webkit-overflow-scrolling: touch;">
      <div class="relative mx-auto my-4 w-full max-w-md bg-white rounded-xl shadow-lg dark:bg-gray-800 overflow-hidden" style="max-height: 90vh;">
        <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between items-center">
          <h2 id="statisticsModalTitle" class="text-xl font-bold text-gray-800 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>Statistics</h2>
          <button type="button" onclick="closeStatisticsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </header>
        <div class="p-4 sm:p-6 overflow-y-auto" style="max-height: calc(90vh - 70px);"><div id="statisticsModalContent"></div></div>
      </div>
    </div>

    <!-- Team Selection Modal -->
    <div id="teamSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 modal" role="dialog" aria-modal="true" aria-labelledby="teamSelectionModalTitle">
      <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800">
        <div class="p-6">
          <h2 id="teamSelectionModalTitle" class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Enter Team Names</h2>
          <form id="teamSelectionForm" class="space-y-4">
            <div>
              <label for="selectUsTeam" class="block text-sm font-medium text-gray-700 dark:text-white">Team "Us"</label>
              <select id="selectUsTeam" name="selectUsTeam" class="mt-1 block w-full border border-gray-300 rounded-xl px-4 py-2 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></select>
              <input type="text" id="newUsTeamName" name="newUsTeamName" class="mt-2 block w-full border border-gray-300 rounded-xl px-4 py-2 dark:bg-gray-600 dark:border-gray-500 dark:text-white hidden" placeholder="New Name for Us" />
            </div>
            <div>
              <label for="selectDemTeam" class="block text-sm font-medium text-gray-700 dark:text-white">Team "Dem"</label>
              <select id="selectDemTeam" name="selectDemTeam" class="mt-1 block w-full border border-gray-300 rounded-xl px-4 py-2 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></select>
              <input type="text" id="newDemTeamName" name="newDemTeamName" class="mt-2 block w-full border border-gray-300 rounded-xl px-4 py-2 dark:bg-gray-600 dark:border-gray-500 dark:text-white hidden" placeholder="New Name for Dem" />
            </div>
            <div class="flex justify-end space-x-2">
              <button type="button" onclick="closeTeamSelectionModal();" class="bg-gray-400 text-white px-4 py-2 rounded-xl hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-400 dark:hover:bg-gray-600 dark:focus:ring-blue-400">Cancel</button>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400">Confirm</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center p-4 modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle" style="-webkit-overflow-scrolling: touch;">
      <div class="relative mx-auto my-8 w-full max-w-lg bg-white rounded-xl shadow-lg dark:bg-gray-800 overflow-hidden" style="max-height: 80vh;">
        <div class="p-6 overflow-y-auto" style="max-height: calc(80vh - 0px);">
            <header class="flex justify-between items-center mb-6">
                <h2 id="settingsModalTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Game Settings</h2>
                <button type="button" onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <section class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>Game Rules</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-600 rounded-lg shadow-sm">
                        <div>
                            <label for="mustWinByBidToggle" class="text-gray-700 dark:text-white font-medium">Must win by making bid</label>
                            <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">If enabled, bidder must make bid to win (even if over 500).</p>
                        </div>
                        <div class="relative ml-4">
                            <input type="checkbox" id="mustWinByBidToggle" class="sr-only peer" onchange="saveSettings()" />
                            <div class="w-14 h-7 bg-gray-200 rounded-full dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border after:border-gray-300 after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7 cursor-pointer" onclick="document.getElementById('mustWinByBidToggle').click()"></div>
                        </div>
                    </div>
                </div>
            </section>
            <section class="bg-gray-50 dark:bg-gray-700 rounded-xl p-5 mb-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>Appearance & Features</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-gray-600 rounded-lg shadow-sm">
                        <div>
                            <label for="proModeToggleModal" class="text-gray-700 dark:text-white font-medium">Pro Mode</label>
                            <p class="text-sm text-gray-500 dark:text-gray-300 mt-1">Enables win probability display.</p>
                        </div>
                        <div class="relative ml-4">
                            <input type="checkbox" id="proModeToggleModal" class="sr-only peer" onchange="toggleProMode(this)" />
                            <div class="w-14 h-7 bg-gray-200 rounded-full dark:bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 peer-checked:bg-blue-600 after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border after:border-gray-300 after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:after:translate-x-7 cursor-pointer" onclick="document.getElementById('proModeToggleModal').click()"></div>
                        </div>
                    </div>
                    <button type="button" onclick="openThemeModal(event)" class="w-full flex items-center justify-between p-3 bg-white dark:bg-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                        <div><span class="text-gray-700 dark:text-white font-medium">Customize Theme Colors</span><p class="text-sm text-gray-500 dark:text-gray-300 mt-1 text-left">Personalize team colors.</p></div>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </button>
                    <div id="editPresetsContainerModal">
                        <button type="button" onclick="openPresetEditorModal()" class="w-full flex items-center justify-between p-3 bg-white dark:bg-gray-600 rounded-lg shadow-sm hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                            <div><span class="text-gray-700 dark:text-white font-medium">Edit Bid Presets</span><p class="text-sm text-gray-500 dark:text-gray-300 mt-1 text-left">Customize quick bid buttons.</p></div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
            </section>
            <footer class="flex justify-end space-x-2">
                <button type="button" onclick="closeSettingsModal()" class="bg-gray-300 text-gray-700 px-5 py-2 rounded-xl hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-500 threed">Close</button>
            </footer>
        </div>
      </div>
    </div>

    <!-- Custom Theme Selection Modal -->
    <div id="themeModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center p-4 modal" role="dialog" aria-modal="true" aria-labelledby="themeModalTitle">
      <div class="bg-white w-full max-w-md rounded-2xl shadow-xl dark:bg-gray-800 overflow-hidden transform transition-all duration-300">
        <header class="px-6 py-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
          <h2 id="themeModalTitle" class="text-xl font-bold text-gray-800 dark:text-white flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>Customize Theme</h2>
          <button type="button" onclick="closeThemeModal(event)" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 focus:outline-none"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        </header>
        <div class="p-6">
          <div class="flex justify-center mb-6">
            <div class="w-full max-w-xs bg-gray-100 dark:bg-gray-700 rounded-xl p-4 flex flex-col items-center">
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Preview</p>
              <div class="flex w-full space-x-3">
                <div id="previewUs" class="flex-1 h-12 rounded-lg shadow-sm flex items-center justify-center text-white font-medium" style="background-color: var(--primary-color);">Us</div>
                <div id="previewDem" class="flex-1 h-12 rounded-lg shadow-sm flex items-center justify-center text-white font-medium" style="background-color: var(--accent-color);">Dem</div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center flex flex-col items-center">
              <label for="usColorPicker" class="block text-sm font-medium text-gray-700 dark:text-white mb-3">Us Team Color</label>
              <input type="color" id="usColorPicker" value="#3b82f6" class="w-16 h-16 cursor-pointer" oninput="updatePreview()" />
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center flex flex-col items-center">
              <label for="demColorPicker" class="block text-sm font-medium text-gray-700 dark:text-white mb-3">Dem Team Color</label>
              <input type="color" id="demColorPicker" value="#ef4444" class="w-16 h-16 cursor-pointer" oninput="updatePreview()" />
            </div>
          </div>
          <div class="mb-6">
            <button type="button" onclick="randomizeThemeColors(); updatePreview();" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-xl hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-md threed flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>Randomize Colors</button>
          </div>
          <footer class="flex space-x-3">
            <button type="button" onclick="applyCustomThemeColors()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 shadow-md threed font-medium">Apply Colors</button>
            <button type="button" onclick="resetThemeColors(); updatePreview();" class="flex-1 bg-gray-200 text-gray-800 py-3 rounded-xl hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 shadow-md threed font-medium dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500">Reset Default</button>
          </footer>
        </div>
      </div>
    </div>
    <!-- Zero-points helper modal -->
<div id="zeroPointsModal"
class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center p-4 modal"
role="dialog" aria-modal="true" aria-labelledby="zeroPointsModalTitle">
<div class="bg-white w-full max-w-md rounded-2xl shadow-xl dark:bg-gray-800">
<div class="p-6 space-y-6">
 <h2 id="zeroPointsModalTitle"
     class="text-2xl font-semibold text-gray-900 dark:text-white">0 points entered</h2>

 <p class="text-gray-600 dark:text-gray-300">
   Did the Bidding team score <strong>180 or 360</strong>?&nbsp; Pick the correct total:
 </p>

 <div class="flex flex-wrap gap-3 justify-center">
   <button id="zeroPts180Btn"
           class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 threed">
     180
   </button>

   <button id="zeroPts360Btn"
           class="px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 threed">
     360
   </button>

   <button id="zeroPtsZeroBtn"
           class="px-4 py-2 bg-gray-300 text-gray-800 rounded-xl hover:bg-gray-400 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 threed">
     Keep&nbsp;0
   </button>
 </div>

 <div class="flex justify-end">
   <button id="zeroPtsCancelBtn"
           class="px-3 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 threed">
     Cancel
   </button>
 </div>
</div>
</div>
</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB_DmalmDfoluZ4HSerI9f8vA70XMGvksY", // This key is public and safe to expose client-side
        authDomain: "rookscore-dadfd.firebaseapp.com",
        projectId: "rookscore-dadfd",
        storageBucket: "rookscore-dadfd.firebasestorage.app",
        messagingSenderId: "395153935926",
        appId: "1:395153935926:web:d76dbb239473f861159297",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const googleProvider = new GoogleAuthProvider();
      googleProvider.setCustomParameters({ prompt: 'select_account' });

      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firestoreDB = db;
      window.firestoreDoc = doc; // Make Firestore 'doc' function globally available
      window.firestoreSetDoc = setDoc; // Make Firestore 'setDoc' function globally available
      window.firestoreGetDoc = getDoc;
      window.googleProvider = googleProvider;

      function updateAuthUI(user) {
        const authLabel = document.getElementById("authLabel");
        if (!authLabel) return;
        if (user) {
          if (user.isAnonymous) {
            authLabel.textContent = "Sign in with Google";
          } else {
            authLabel.innerHTML = `Sign Out <img src="${user.photoURL}" alt="Profile" style="display:inline-block;width:24px;height:24px;border-radius:50%;vertical-align:middle;margin-left:8px;">`;
            authLabel.style.display = 'inline-flex';
            authLabel.style.alignItems = 'center';
          }
        } else {
          authLabel.textContent = "Sign in with Google";
        }
      }

      async function loadFirestoreData(user) {
        // This function is called by the main script's onAuthStateChanged logic if needed
        // For now, the main script handles loading after merge/anonymous sign-in
        if (user && !user.isAnonymous) {
            console.log("Loading data from Firestore for user:", user.uid);
            try {
                const docRef = doc(db, "rookData", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Found data in Firestore, merging/loading is handled by main script");
                    const data = docSnap.data();
                    // The main script's mergeLocalStorageWithFirestore will handle this
                    // For safety, we can iterate and set if not already done by merge
                    for (const [key, value] of Object.entries(data)) {
                        if (key !== "timestamp" && !localStorage.getItem(key)) { // Only if not already set by merge
                             localStorage.setItem(key, JSON.stringify(value));
                        }
                    }
                } else {
                    console.log("No data found in Firestore for this user, local data will be used/synced up.");
                }
            } catch (error) {
                console.error("Error loading from Firestore:", error);
            }
        }
        // Ensure renderApp is called from the main script after all data ops
        if (window.renderApp) window.renderApp();
      }
      
      window.mergeLocalStorageWithFirestore = async function(user) {
        const docRef = doc(db, "rookData", user.uid);
        const docSnap = await getDoc(docRef);
        let firestoreData = docSnap.exists() ? docSnap.data() : {};
        const localData = {};

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key.startsWith('firebase')) { // Avoid Firebase's own keys
                try {
                    localData[key] = JSON.parse(localStorage.getItem(key));
                } catch (e) {
                    console.warn(`Could not parse localStorage key ${key}:`, e);
                    localData[key] = localStorage.getItem(key); // Store as raw string if parse fails
                }
            }
        }

        const mergedData = {};
        const allKeys = new Set([...Object.keys(localData), ...Object.keys(firestoreData)]);

        allKeys.forEach(key => {
            if (key === "timestamp") return;

            const localValue = localData[key];
            const firestoreValue = firestoreData[key];

            // Prioritize local data for active game to avoid overwriting unsaved changes
            // For other items like savedGames, attempt a merge or use the most recent
            if (key === "activeGameState") { // ACTIVE_GAME_KEY from main script
                 mergedData[key] = localValue || firestoreValue || window.DEFAULT_STATE || {}; // Ensure some default
            } else if (Array.isArray(localValue) && Array.isArray(firestoreValue) && (key === "savedGames" || key === "freezerGames")) {
                // Merge arrays of games, ensuring uniqueness by timestamp or a unique ID if available
                const combined = [...localValue, ...firestoreValue];
                const uniqueMap = new Map();
                combined.forEach(item => {
                    // Prefer item.id or item.timestamp for uniqueness
                    const uniqueKey = item.id || item.timestamp || JSON.stringify(item); // Fallback to stringify
                    if (!uniqueMap.has(uniqueKey)) {
                        uniqueMap.set(uniqueKey, item);
                    } else {
                        // Basic conflict resolution: take the one with a later timestamp if available
                        const existingItem = uniqueMap.get(uniqueKey);
                        if (item.timestamp && existingItem.timestamp && new Date(item.timestamp) > new Date(existingItem.timestamp)) {
                            uniqueMap.set(uniqueKey, item);
                        }
                        // More complex merging could be done here if needed
                    }
                });
                mergedData[key] = Array.from(uniqueMap.values());
            } else if (typeof localValue === 'object' && localValue !== null && typeof firestoreValue === 'object' && firestoreValue !== null) {
                // Simple object merge, local overrides remote for simple key-value settings
                mergedData[key] = { ...firestoreValue, ...localValue };
            } else {
                // Default to local if present, else remote, else undefined
                mergedData[key] = localValue !== undefined ? localValue : firestoreValue;
            }
        });

        mergedData.timestamp = new Date().toISOString();
        await setDoc(docRef, mergedData, { merge: true });

        // Update localStorage with merged data
        Object.entries(mergedData).forEach(([key, value]) => {
            if (key !== "timestamp") {
                localStorage.setItem(key, JSON.stringify(value));
            }
        });
        
        // Re-initialize state from potentially merged localStorage
        if (window.loadCurrentGameState) window.loadCurrentGameState(); 
        if (window.renderApp) window.renderApp();
      }


      window.signInWithGoogle = async function() {
        try {
          const result = await signInWithPopup(auth, googleProvider);
          const googleUser = result.user;
          window.firebaseReady = true;
          updateAuthUI(googleUser);
          await window.mergeLocalStorageWithFirestore(googleUser); // Use the global one
        } catch (error) {
          console.error("Google sign-in failed:", error);
          if (window.renderApp) window.renderApp(); // Still render the app
        }
      };

      window.signOutUser = async function() {
        try {
          await signOut(auth);
          window.firebaseReady = false; // Or handle as anonymous
          // The onAuthStateChanged listener will trigger anonymous sign-in
        } catch (error) {
          console.error("Sign-out failed:", error);
        }
      };
      
      window.syncToFirestore = async function(key, value) {
        if (!window.firebaseAuth || !window.firestoreDB) {
          console.warn("Firebase not initialized for sync.");
          return false;
        }
        if (!window.firebaseAuth.currentUser || window.firebaseAuth.currentUser.isAnonymous) {
          console.log("User not signed in with Google or is anonymous. Not syncing to Firestore.");
          return false;
        }
        try {
          const userId = window.firebaseAuth.currentUser.uid;
          await window.firestoreSetDoc( // Use global setDoc
            window.firestoreDoc(window.firestoreDB, "rookData", userId), // Use global doc
            { [key]: value, timestamp: new Date().toISOString() },
            { merge: true }
          );
          console.log(`Successfully synced ${key} to Firestore.`);
          return true;
        } catch (error) {
          console.error("Firestore sync error:", error);
          return false;
        }
      };

      // Initial Auth State Handling
      document.addEventListener('DOMContentLoaded', () => {
        let authTimeoutId = setTimeout(() => {
            console.log("Firebase auth timed out - likely offline or blocked.");
            window.firebaseReady = false;
            updateAuthUI(null);
            if (window.loadCurrentGameState) window.loadCurrentGameState();
            if (window.renderApp) window.renderApp();
        }, 5000); // 5 second timeout

        onAuthStateChanged(auth, (user) => {
            clearTimeout(authTimeoutId);
            if (user) {
                window.firebaseReady = true;
                updateAuthUI(user);
                if (!user.isAnonymous) {
                    window.mergeLocalStorageWithFirestore(user); // Use global one
                } else {
                    // For anonymous users, just load local state. Sync up happens if they sign in.
                    if (window.loadCurrentGameState) window.loadCurrentGameState();
                    if (window.renderApp) window.renderApp();
                }
            } else {
                signInAnonymously(auth)
                    .then((anonUserCredential) => {
                        window.firebaseReady = true; // Firebase is working for anon
                        updateAuthUI(anonUserCredential.user);
                        if (window.loadCurrentGameState) window.loadCurrentGameState();
                        if (window.renderApp) window.renderApp();
                    })
                    .catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        window.firebaseReady = false;
                        updateAuthUI(null);
                        if (window.loadCurrentGameState) window.loadCurrentGameState();
                        if (window.renderApp) window.renderApp();
                    });
            }
        });
      });
    </script>
    <script>
      "use strict";

      // --- Configuration & Constants ---
      const MUST_WIN_BY_BID_KEY = "rookMustWinByBid";
      const ACTIVE_GAME_KEY = "activeGameState";
      const DARK_MODE_KEY = "darkModeEnabled";
      const PRO_MODE_KEY = "proModeEnabled";
      const THEME_KEY = "rookSelectedTheme";
      const PRESET_BIDS_KEY = 'customPresetBids';
      const DEFAULT_STATE = {
        rounds: [], undoneRounds: [], biddingTeam: "", bidAmount: "",
        customBidValue: "", showCustomBid: false, enterBidderPoints: false,
        error: "", gameOver: false, winner: null, victoryMethod: null,
        savedScoreInputStates: { us: null, dem: null }, lastBidAmount: null,
        lastBidTeam: null, usTeamName: "", demTeamName: "", startTime: null,
        accumulatedTime: 0, showWinProbability: false, pendingPenalty: null,
      };

      // --- Global State ---
      let state = { ...DEFAULT_STATE };
      let confettiTriggered = false;
      let ephemeralCustomBid = ""; // For temporarily holding input value before state update
      let ephemeralPoints = "";    // Same for points
      let confirmationCallback = null;
      let noCallback = null;
      let pendingGameAction = null; // For actions requiring team name input first

      let presetBids;
        try {
          const raw = localStorage.getItem(PRESET_BIDS_KEY);
          const parsed = JSON.parse(raw);
          presetBids   = Array.isArray(parsed) && parsed.length ? parsed : null;
         } catch (_) { presetBids = null; }
        if (!presetBids) presetBids = [120,125,130,135,140,145,"other"]; 

      let scoreCardHasAnimated  = false;
      let historyCardHasAnimated = false;

      function renderWinProbability() {
  // Only show if enabled
  if (!state.showWinProbability) return "";
  
  const { rounds, usTeamName, demTeamName, gameOver } = state;
  if (rounds.length === 0 || gameOver) return "";
  const historicalGames = getLocalStorage("savedGames");
  const winProb = calculateWinProbability(state, historicalGames);
  const labelUs = usTeamName || "Us";
  const labelDem = demTeamName || "Dem";
  return `
    <div id="winProbabilityDisplay" class="text-center text-sm text-gray-600 dark:text-gray-300">
      <span class="inline-block px-4">${labelUs}: ${winProb.us.toFixed(1)}%</span>
      <span class="inline-block px-4">${labelDem}: ${winProb.dem.toFixed(1)}%</span>
    </div>
  `;
}

function calculateWinProbability(currentGame, historicalGames) {
  const { rounds } = currentGame;
  
  if (!rounds || rounds.length === 0) {
    console.log("Win Probabilities: US=50%, DEM=50%");
    console.log("Factors: None - No rounds played");
    return { us: 50, dem: 50, factors: [] };
  }
  
  // Get current scores
  const lastRound = rounds[rounds.length - 1];
  const currentScores = lastRound.runningTotals || { us: 0, dem: 0 };
  const scoreDiff = currentScores.us - currentScores.dem;
  const roundsPlayed = rounds.length;
  
  // Base probability calculation from score difference
  let baseProb = 50 + (scoreDiff / 15);  // Each 12 points is worth 1% advantage
  
  // Adjust for tendency to come back from behind
  let comebackFactor = 0;
  
  // Find similar historical games based on completion status and rounds
  const relevantGames = historicalGames.filter(game => {
    return game.rounds && 
           game.rounds.length > 0 && 
           game.rounds.length >= roundsPlayed && 
           game.finalScore && 
           (game.finalScore.us !== undefined || game.finalScore.dem !== undefined);
  });
  
  // Analyze comebacks in historical games
  if (relevantGames.length > 0) {
    let comebackCount = 0;
    let totalSimilarSituations = 0;
    
    relevantGames.forEach(game => {
      if (!game.rounds || game.rounds.length <= roundsPlayed) return;
      
      const historicalRound = game.rounds[roundsPlayed - 1];
      const finalScores = game.finalScore;
      
      if (!historicalRound || !finalScores) return;
      
      const historicalScores = historicalRound.runningTotals;
      if (!historicalScores) return;
      
      const historicalLeader = historicalScores.us > historicalScores.dem ? "us" : "dem";
      const finalWinner = finalScores.us > finalScores.dem ? "us" : "dem";
      
      if (historicalLeader !== finalWinner) {
        comebackCount++;
      }
      
      totalSimilarSituations++;
    });
    
    if (totalSimilarSituations > 0) {
      const comebackRate = comebackCount / totalSimilarSituations;
      comebackFactor = Math.round(comebackRate * 10); // Max 10% adjustment
    }
  }
  
  // Momentum factor based on recent rounds
  let momentumFactor = 0;
  if (rounds.length >= 3) {
    let recentUsPoints = 0;
    let recentDemPoints = 0;
    
    for (let i = rounds.length - 3; i < rounds.length; i++) {
      if (i >= 0) {
        recentUsPoints += rounds[i].usPoints || 0;
        recentDemPoints += rounds[i].demPoints || 0;
      }
    }
    
    if (recentUsPoints > recentDemPoints) {
      momentumFactor = 2;
    } else if (recentDemPoints > recentUsPoints) {
      momentumFactor = -2;
    }
  }
  
  // Bid strength factor
  let bidStrengthFactor = 0;
  const usHighBids = rounds.filter(r => r.biddingTeam === "us" && r.bidAmount >= 140).length;
  const demHighBids = rounds.filter(r => r.biddingTeam === "dem" && r.bidAmount >= 140).length;
  
  if (usHighBids > demHighBids) {
    bidStrengthFactor = 2;
  } else if (demHighBids > usHighBids) {
    bidStrengthFactor = -2;
  }
  
  // Calculate final probability
  const adjustedProb = Math.min(Math.max(baseProb + momentumFactor + comebackFactor + bidStrengthFactor, 1), 99);
  
  // Factors for explanation
  const factors = [
    { name: "Score Difference", value: Math.round((scoreDiff / 20)), description: `${Math.abs(scoreDiff)} point difference` },
    { name: "Momentum", value: momentumFactor, description: momentumFactor !== 0 ? `Recent rounds trend` : "No clear momentum" },
    { name: "Comeback Tendency", value: comebackFactor, description: `Based on ${relevantGames.length} completed games` },
    { name: "Bid Strength", value: bidStrengthFactor, description: `High bids: us (${usHighBids}), dem (${demHighBids})` }
  ];
  
  return {
    us: adjustedProb,
    dem: 100 - adjustedProb,
    factors: factors
  };
}

      // --- Local Storage & Sync ---
      function setLocalStorage(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          if (window.syncToFirestore && window.firebaseReady && window.firebaseAuth?.currentUser && !window.firebaseAuth.currentUser.isAnonymous) {
            // Non-blocking sync
            setTimeout(() => {
              window.syncToFirestore(key, value).catch(err => console.warn(`Firestore sync failed for ${key}:`, err));
            }, 0);
          }
        } catch (error) {
          console.error(`Error in setLocalStorage for key ${key}:`, error);
        }
      }

      function getLocalStorage(key) {
  // grab the raw string (or null if the key isn't present)
  const raw = localStorage.getItem(key);

  // nothing stored yet → sensible defaults
  if (raw === null) {
    // for the two keys that always hold arrays we return an empty array,
    // everything else gets an empty object so later code can still `...spread`
    if (key === "savedGames" || key === "freezerGames") return [];
    return {};
  }

  // try to parse JSON — most of our keys are JSON-encoded
  try {
    return JSON.parse(raw);
  } catch (err) {
    // not valid JSON (legacy plain string, hand-edited, etc.)
    console.warn(`localStorage[${key}] is not JSON – returning the raw value`, err);
    return raw;        // fall back to the literal string so the app keeps running
  }
}

      
      // --- Icons ---
      const Icons = { // SVG strings for icons to avoid multiple DOM elements
        AlertCircle: '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v4m0 4h.01"></path></svg>',
        Undo: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v6h6M21 17a9 9 0 0 0-9-9c-2.5 0-4.75.9-6.5 2.4L3 11"/></svg>',
        Redo: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7v6h-6M3 17a9 9 0 0 1 9-9c2.5 0 4.75.9 6.5 2.4L21 11"/></svg>',
        Trash: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>',
        Load: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>',
        Trophy: '<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 10V4h10v6M7 10l-1 12h12 l-1-12M7 10h10m-5 12v-6"/></svg>',
      };

      // --- Bid Preset Logic ---
      function savePresetBids() { setLocalStorage(PRESET_BIDS_KEY, presetBids); }
      function openPresetEditorModal() {
        // No longer restrict to Pro Mode
        const modalHtml = `
            <div id="presetEditorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 modal" role="dialog" aria-modal="true" aria-labelledby="presetEditorTitle">
                <div class="bg-white w-full max-w-md rounded-xl shadow-lg dark:bg-gray-800 p-6 transform transition-all">
                    <div class="flex items-center justify-between mb-4">
                        <h2 id="presetEditorTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Edit Bid Presets</h2>
                        <button type="button" onclick="closePresetEditorModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 rounded-full p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Customize quick bid buttons. Values must be multiples of 5.</p>
                    <div id="presetInputs" class="space-y-3 max-h-64 overflow-y-auto pr-2 mb-4">
                        ${presetBids.filter(b => b !== "other").map((bid, index) => `
                            <div class="flex items-center space-x-3 preset-input-row">
                                <div class="flex-grow relative">
                                    <input type="number" value="${bid}" min="5" max="360" step="5" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-index="${index}" onchange="validatePresetInput(this)">
                                    <div class="preset-error text-xs text-red-500 mt-1 hidden"></div>
                                </div>
                                <button type="button" onclick="removePreset(${index})" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-red-600 hover:text-red-700 dark:text-red-400 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">${Icons.Trash}</button>
                            </div>`).join('')}
                    </div>
                    <div class="flex gap-2 flex-wrap mb-6">
                        <button type="button" onclick="addPreset()" class="flex items-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-800/40 text-blue-600 dark:text-blue-400 px-4 py-2 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors threed"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>Add Preset</button>
                    </div>
                    <div id="presetErrorMsg" class="text-red-500 text-sm mb-4 hidden"></div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closePresetEditorModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors threed">Cancel</button>
                        <button type="button" onclick="savePresets()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors threed">Save Changes</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.body.classList.add('modal-open');
      }
      function closePresetEditorModal() {
        const modal = document.getElementById('presetEditorModal');
        if (modal) { modal.remove(); document.body.classList.remove('modal-open'); }
      }
      /* ---------- zero-points modal helpers ---------- */
function openZeroPointsModal(chooseCallback) {
  const modalEl = document.getElementById("zeroPointsModal");
  modalEl.classList.remove("hidden");
  document.body.classList.add("modal-open");
  document.getElementById("app")?.classList.add("modal-active");

  const close = () => {
    modalEl.classList.add("hidden");
    document.body.classList.remove("modal-open");
    document.getElementById("app")?.classList.remove("modal-active");
    // clean up listeners so they can't pile up
    ["zeroPts180Btn","zeroPts360Btn","zeroPtsZeroBtn","zeroPtsCancelBtn"]
      .forEach(id => {
        const btn=document.getElementById(id);
        const newBtn=btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn,btn);
      });
  };

  document.getElementById("zeroPts180Btn").onclick = () => { close(); chooseCallback(180); };
  document.getElementById("zeroPts360Btn").onclick = () => { close(); chooseCallback(360); };
  document.getElementById("zeroPtsZeroBtn").onclick  = () => { close(); chooseCallback(0);   };
  document.getElementById("zeroPtsCancelBtn").onclick = close;
}
/* ---------------------------------------------- */

      function validatePresetInput(inputEl) {
        const val = Number(inputEl.value);
        const errDiv = inputEl.nextElementSibling;
        let msg = "";
        if (isNaN(val)) msg = "Must be a number.";
        else if (val <= 0) msg = "Must be > 0.";
        else if (val % 5 !== 0) msg = "Must be div by 5.";
        else if (val > 360) msg = "Cannot exceed 360.";
        errDiv.textContent = msg;
        errDiv.classList.toggle("hidden", !msg);
        return !msg;
      }
      function addPreset() {
        const container = document.getElementById('presetInputs');
        const newIdx = container.querySelectorAll('.preset-input-row').length;
        container.insertAdjacentHTML('beforeend', `
            <div class="flex items-center space-x-3 preset-input-row animate-fadeIn">
                <div class="flex-grow relative">
                    <input type="number" value="120" min="5" max="360" step="5" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" data-index="${newIdx}" onchange="validatePresetInput(this)">
                    <div class="preset-error text-xs text-red-500 mt-1 hidden"></div>
                </div>
                <button type="button" onclick="removePreset(${newIdx})" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-red-600 hover:text-red-700 dark:text-red-400 p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">${Icons.Trash}</button>
            </div>`);
        container.scrollTop = container.scrollHeight;
      }
      function removePreset(index) {
        const rows = document.querySelectorAll('#presetInputs .preset-input-row');
        const errorMsgEl = document.getElementById('presetErrorMsg');
        if (rows.length <= 1) {
            errorMsgEl.textContent = 'Must have at least one preset.';
            errorMsgEl.classList.remove('hidden');
            setTimeout(() => errorMsgEl.classList.add('hidden'), 3000);
            return;
        }
        const rowToRemove = Array.from(rows).find(r => r.querySelector('input[data-index]')?.dataset.index == index);
        if (rowToRemove) {
            rowToRemove.classList.add('animate-fadeOut');
            setTimeout(() => {
                rowToRemove.remove();
                // Re-index remaining rows
                document.querySelectorAll('#presetInputs .preset-input-row').forEach((r, i) => {
                    r.querySelector('input').dataset.index = i;
                    r.querySelector('button').setAttribute('onclick', `removePreset(${i})`);
                });
            }, 150);
        }
      }
      function sortPresets() {
        const inputs = Array.from(document.querySelectorAll('#presetInputs input'));
        const errorMsgEl = document.getElementById('presetErrorMsg');
        if (inputs.some(input => !validatePresetInput(input))) {
            errorMsgEl.textContent = 'Fix errors before sorting.';
            errorMsgEl.classList.remove('hidden');
            setTimeout(() => errorMsgEl.classList.add('hidden'), 3000);
            return;
        }
        const sortedValues = inputs.map(input => Number(input.value)).sort((a, b) => a - b);
        inputs.forEach((input, i) => input.value = sortedValues[i]);
      }
      function savePresets() {
        const inputs = Array.from(document.querySelectorAll('#presetInputs input'));
        const errorMsgEl = document.getElementById('presetErrorMsg');
        if (inputs.some(input => !validatePresetInput(input))) {
            errorMsgEl.textContent = 'Fix errors before saving.';
            errorMsgEl.classList.remove('hidden');
            return;
        }
        const newPresetsNum = inputs.map(input => Number(input.value));
        if (new Set(newPresetsNum).size !== newPresetsNum.length) {
            errorMsgEl.textContent = 'Duplicate values not allowed.';
            errorMsgEl.classList.remove('hidden');
            return;
        }
        if (newPresetsNum.length === 0) {
            errorMsgEl.textContent = 'At least one preset required.';
            errorMsgEl.classList.remove('hidden');
            return;
        }
        presetBids = [...newPresetsNum.sort((a, b) => a - b), "other"];
        savePresetBids();
        closePresetEditorModal();
        renderApp();
        showSaveIndicator("Bid presets updated");
      }
      
      // --- Migrations ---
      // Removed performDataMigration and all migration logic

      // --- Theme & UI Helpers ---
      function initializeDarkMode() {
        const isDark = JSON.parse(localStorage.getItem(DARK_MODE_KEY) || "false");
        document.documentElement.classList.toggle("dark", isDark);
        const toggle = document.getElementById("darkModeToggle");
        if (toggle) toggle.checked = isDark;
        updateMetaThemeColor(isDark);
      }
      function updateMetaThemeColor(isDark) {
        document.querySelector('meta[name="theme-color"]').setAttribute("content", isDark ? "#1a202c" : "#ffffff");
      }

      /**
 * Initialise the <body> classes and colours.
 *  – keeps compulsory base classes (bg‑white … dark:bg-gray-900 …)
 *  – migrates themes saved by versions < 1.4.5
 *  – works even if user previously saved   theme‑blue‑red   etc.
 *  – guarantees the correct background colour **at runtime**
 */
function initializeTheme() {
  const body   = document.getElementById("bodyRoot") || document.body;
  const THEME_KEY = "rookSelectedTheme";

  /* ------------------------------------------------------------------ */
  /* 1.  Classes that the layout ALWAYS needs                            */
  /* ------------------------------------------------------------------ */
  const BASE_BODY_CLASSES = [
    "bg-white",                    // light‑mode background
    "text-gray-800",               // light‑mode text colour
    "min-h-screen",
    "transition-colors", "duration-300",
    "dark:bg-gray-900",            // dark‑mode background
    "dark:text-white"              // dark‑mode text colour
  ];

  /* ------------------------------------------------------------------ */
  /* 2.  Read & (if necessary) migrate the user‑saved theme             */
  /* ------------------------------------------------------------------ */
  let savedClasses = localStorage.getItem(THEME_KEY) || "";   // may be ""

  // Any value saved by versions < 1.4.5 is missing the dark bg class.
  const needsMigration = savedClasses &&
                         !savedClasses.includes("dark:bg-gray-900");

  if (needsMigration) {
    savedClasses = `${BASE_BODY_CLASSES.join(" ")} ${savedClasses}`.trim();
    localStorage.setItem(THEME_KEY, savedClasses);   // write back once
  }

  /* ------------------------------------------------------------------ */
  /* 3.  Compose the final class list, remove duplicates                */
  /* ------------------------------------------------------------------ */
  const finalClassList = new Set([
    ...BASE_BODY_CLASSES,
    ...(savedClasses ? savedClasses.split(/\s+/) : ["theme-blue-red"])
  ]);

  body.className = Array.from(finalClassList).join(" ");

  /* ------------------------------------------------------------------ */
  /* 4.  LAST LINE OF DEFENCE – guarantee the background at runtime     */
  /*     (overrides any theme class that still happens to win the CSS)  */
  /* ------------------------------------------------------------------ */
  const darkIsOn  = document.documentElement.classList.contains("dark");
  const computed  = getComputedStyle(body).backgroundColor;

  const rgbWhite  = "rgb(255, 255, 255)";
  const rgbDark   = "rgb(17, 24, 39)";               // Tailwind gray‑900

  if (darkIsOn && computed !== rgbDark) {
    body.style.backgroundColor = rgbDark;            // force dark bg
  } else if (!darkIsOn && computed !== rgbWhite) {
    body.style.backgroundColor = rgbWhite;           // force light bg
  }
}
      function isValidHexColor(colorString) {
  if (!colorString || typeof colorString !== 'string') return false;
  // Basic hex color validation (e.g., #RRGGBB or #RGB)
  return /^#([0-9A-F]{3}){1,2}$/i.test(colorString);
}

function initializeCustomThemeColors() {
  const rootStyles = getComputedStyle(document.documentElement);
  const defaultUsColor = rootStyles.getPropertyValue('--primary-color').trim() || "#3b82f6";
  const defaultDemColor = rootStyles.getPropertyValue('--accent-color').trim() || "#ef4444";

  let usColor = localStorage.getItem('customUsColor');
  let demColor = localStorage.getItem('customDemColor');

  const body = document.getElementById('bodyRoot');
  const usPicker = document.getElementById('usColorPicker');
  const demPicker = document.getElementById('demColorPicker');

  if (isValidHexColor(usColor)) {
    body.style.setProperty('--primary-color', usColor);
    if (usPicker) usPicker.value = usColor;
  } else {
    if (usColor !== null) { // Only warn if there was an attempt to set an invalid color
        console.warn(`Invalid customUsColor ("${usColor}") in localStorage. Using default.`);
        // localStorage.removeItem('customUsColor'); // Optionally remove invalid item
    }
    body.style.setProperty('--primary-color', defaultUsColor);
    if (usPicker) usPicker.value = defaultUsColor;
  }

  if (isValidHexColor(demColor)) {
    body.style.setProperty('--accent-color', demColor);
    if (demPicker) demPicker.value = demColor;
  } else {
    if (demColor !== null) {
        console.warn(`Invalid customDemColor ("${demColor}") in localStorage. Using default.`);
        // localStorage.removeItem('customDemColor');
    }
    body.style.setProperty('--accent-color', defaultDemColor);
    if (demPicker) demPicker.value = defaultDemColor;
  }
  updatePreview(); // Ensure preview matches
}
      function applyCustomThemeColors() {
        const usColor = document.getElementById('usColorPicker').value;
        const demColor = document.getElementById('demColorPicker').value;
        document.getElementById('bodyRoot').style.setProperty('--primary-color', usColor);
        document.getElementById('bodyRoot').style.setProperty('--accent-color', demColor);
        localStorage.setItem('customUsColor', usColor);
        localStorage.setItem('customDemColor', demColor);
        closeThemeModal(null); // Pass null if event is not available or needed
      }
      function resetThemeColors() {
        const defaultUs = "#3b82f6", defaultDem = "#ef4444";
        document.getElementById('bodyRoot').style.setProperty('--primary-color', defaultUs);
        document.getElementById('bodyRoot').style.setProperty('--accent-color', defaultDem);
        localStorage.removeItem('customUsColor');
        localStorage.removeItem('customDemColor');
        const usPicker = document.getElementById('usColorPicker');
        const demPicker = document.getElementById('demColorPicker');
        if (usPicker) usPicker.value = defaultUs;
        if (demPicker) demPicker.value = defaultDem;
        updatePreview();
      }
      function hslToHex(h, s, l) { // Helper for random colors
        s /= 100; l /= 100;
        const k = n => (n + h / 30) % 12;
        const a = s * Math.min(l, 1 - l);
        const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
        return "#" + [0, 8, 4].map(n => Math.round(f(n) * 255).toString(16).padStart(2, '0')).join('');
      }
      function randomizeThemeColors() {
        const h = Math.floor(Math.random() * 360);
        const s = Math.floor(Math.random() * 51) + 50; // Saturation 50-100%
        const l = Math.floor(Math.random() * 41) + 30; // Lightness 30-70%
        document.getElementById('usColorPicker').value = hslToHex(h, s, l);
        document.getElementById('demColorPicker').value = hslToHex((h + 180) % 360, s, l); // Complementary
        updatePreview();
      }
      function updatePreview() {
        const usColor = document.getElementById('usColorPicker')?.value;
        const demColor = document.getElementById('demColorPicker')?.value;
        const previewUs = document.getElementById('previewUs');
        const previewDem = document.getElementById('previewDem');
        if (previewUs && usColor) previewUs.style.backgroundColor = usColor;
        if (previewDem && demColor) previewDem.style.backgroundColor = demColor;
      }
       function openThemeModal(event) {
        if (event) { event.preventDefault(); event.stopPropagation(); }
        document.getElementById("settingsModal")?.classList.add("hidden");
        const themeModalEl = document.getElementById("themeModal");
        if (themeModalEl) {
            themeModalEl.classList.remove("hidden");
            const content = themeModalEl.querySelector(".bg-white, .dark\\:bg-gray-800");
            if (content) content.onclick = e => e.stopPropagation(); // Prevent closing on content click
            initializeCustomThemeColors(); // Ensure pickers and preview are up-to-date
        }
      }
      function closeThemeModal(event) {
        if (event) { event.preventDefault(); event.stopPropagation(); }
        document.getElementById("themeModal")?.classList.add("hidden");
        document.getElementById("settingsModal")?.classList.remove("hidden"); // Show settings modal again
      }
      function showSaveIndicator(message = "Saved") {
        const el = document.getElementById("saveIndicator");
        if (!el) return;
        el.textContent = message;
        el.classList.remove("hidden", "bg-red-600"); // Remove error class if present
        el.classList.add("show");
        setTimeout(() => { el.classList.remove("show"); setTimeout(() => el.classList.add("hidden"), 150); }, 1000);
      }

      // --- Game State Management ---
      function updateState(newState) {
        state = { ...state, ...newState };
        renderApp();
      }
      function resetGame() {
        const isProMode = JSON.parse(localStorage.getItem(PRO_MODE_KEY) || "false");
        updateState({
    ...DEFAULT_STATE,
    usTeamName : "",      // blank ⇒ UI falls back to "Us"
    demTeamName: "",      // blank ⇒ UI falls back to "Dem"
    showWinProbability: isProMode,
    pendingPenalty : null
  });
        confettiTriggered = false;
        ephemeralCustomBid = "";
        ephemeralPoints = "";
        localStorage.removeItem(ACTIVE_GAME_KEY);
        // Attempt to also clear from Firebase if user is signed in
        if (window.syncToFirestore && window.firebaseReady && window.firebaseAuth?.currentUser && !window.firebaseAuth.currentUser.isAnonymous) {
            window.syncToFirestore(ACTIVE_GAME_KEY, null); // Sync deletion of active game
        }
      }
      function loadCurrentGameState() {
  let loadedState = null; // Initialize to null
  try {
    const storedStateString = localStorage.getItem(ACTIVE_GAME_KEY);
    if (storedStateString) {
      loadedState = JSON.parse(storedStateString);
    }
  } catch (e) {
    console.error("Error parsing activeGameState from localStorage. Will reset to default state.", e);
    localStorage.removeItem(ACTIVE_GAME_KEY); // Critical: remove the corrupted state
    // loadedState remains null, so it will fall through to using DEFAULT_STATE
  }

  if (loadedState && typeof loadedState === 'object' && loadedState !== null && Array.isArray(loadedState.rounds)) {
    // Ensure all DEFAULT_STATE keys are present, preferring loaded values
    const completeLoadedState = { ...DEFAULT_STATE, ...loadedState };
    // Ensure showWinProbability is correctly set from localStorage PRO_MODE_KEY
    completeLoadedState.showWinProbability = JSON.parse(localStorage.getItem(PRO_MODE_KEY) || "false"); // Add try-catch for this too
    updateState(completeLoadedState);
  } else {
    if (loadedState) { // If it was parsed but didn't meet structure checks
        console.warn("Loaded activeGameState has invalid structure. Resetting to default state.");
        localStorage.removeItem(ACTIVE_GAME_KEY); // Remove invalid structure
    }
    // Fallback to default state
    updateState({
      ...DEFAULT_STATE,
      usTeamName: "", // Or load from a separate team name storage if you have one
      demTeamName: "",
      showWinProbability: JSON.parse(localStorage.getItem(PRO_MODE_KEY) || "false"), // Add try-catch here as well
      startTime: Date.now() // Start time for a new game
    });
  }
}
      function saveCurrentGameState() {
        if (state.gameOver) {
          localStorage.removeItem(ACTIVE_GAME_KEY);
          if (window.syncToFirestore && window.firebaseReady && window.firebaseAuth?.currentUser && !window.firebaseAuth.currentUser.isAnonymous) {
            window.syncToFirestore(ACTIVE_GAME_KEY, null);
          }
        } else {
          setLocalStorage(ACTIVE_GAME_KEY, state); // This now handles Firestore sync too
          showSaveIndicator();
        }
      }

      // --- Team Stats Helpers ---
      function getTeamsObject() { return getLocalStorage("teams") || {}; }
      function setTeamsObject(obj) { setLocalStorage("teams", obj); }
      function updateTeamsStatsOnGameEnd(winner) {
        if (!state.usTeamName || !state.demTeamName) return;
        const teams = getTeamsObject();
        const usKey = state.usTeamName.trim(), demKey = state.demTeamName.trim();
        if (!teams[usKey]) teams[usKey] = { wins: 0, losses: 0, gamesPlayed: 0 };
        if (!teams[demKey]) teams[demKey] = { wins: 0, losses: 0, gamesPlayed: 0 };
        teams[usKey].gamesPlayed++;
        teams[demKey].gamesPlayed++;
        if (winner === "us") { teams[usKey].wins++; teams[demKey].losses++; }
        else if (winner === "dem") { teams[demKey].wins++; teams[usKey].losses++; }
        setTeamsObject(teams);
      }
      function recalcTeamsStats() { /* See getStatistics for actual calculation logic */ }
      function addTeamIfNotExists(teamName) {
        const teams = getTeamsObject();
        if (!teams[teamName]) teams[teamName] = { wins: 0, losses: 0, gamesPlayed: 0 };
        setTeamsObject(teams);
      }

      // --- Menu & Modal Toggling ---
      function toggleMenu(e) {
        if (e) e.stopPropagation();
        const menu = document.getElementById("menu");
        const icon = document.getElementById("hamburgerIcon");
        const overlay = document.getElementById("menuOverlay");
        const isOpen = menu.classList.toggle("show");
        icon.classList.toggle("open", isOpen);
        overlay.classList.toggle("show", isOpen);
        document.body.classList.toggle("overflow-hidden", isOpen);
      }
      function closeMenuOverlay() { toggleMenu(null); } // Simplified close

      function openModal(modalId) {
        document.getElementById(modalId)?.classList.remove("hidden");
        document.body.classList.add("modal-open");
        document.getElementById("app")?.classList.add("modal-active");
        document.getElementById(modalId)?.focus(); // For accessibility
      }
      function closeModal(modalId) {
        document.getElementById(modalId)?.classList.add("hidden");
        document.body.classList.remove("modal-open");
        document.getElementById("app")?.classList.remove("modal-active");
      }
      function openSavedGamesModal() {
        updateGamesCount();
        switchGamesTab('completed'); // Default to completed games
        renderGamesWithFilter(); // Render based on default filter/sort
        openModal("savedGamesModal");
      }
      function closeSavedGamesModal() { closeModal("savedGamesModal"); }
      function openConfirmationModal(message, yesCb, noCb) {
        document.getElementById("confirmationModalMessage").textContent = message;
        confirmationCallback = yesCb; noCallback = noCb;
        openModal("confirmationModal");
        // Re-bind buttons to avoid multiple listeners if not careful
        const yesBtn = document.getElementById("confirmModalButton");
        const noBtn = document.getElementById("noModalButton");
        const newYes = yesBtn.cloneNode(true); yesBtn.parentNode.replaceChild(newYes, yesBtn);
        const newNo = noBtn.cloneNode(true); noBtn.parentNode.replaceChild(newNo, noBtn);
        newYes.addEventListener("click", (e) => { e.stopPropagation(); if (confirmationCallback) confirmationCallback(); });
        newNo.addEventListener("click", (e) => { e.stopPropagation(); if (noCallback) noCallback(); });
      }
      function closeConfirmationModal() { closeModal("confirmationModal"); confirmationCallback = null; noCallback = null; }
      function openTeamSelectionModal() { populateTeamSelects(); openModal("teamSelectionModal"); }
      function closeTeamSelectionModal() { closeModal("teamSelectionModal"); }
      function openSettingsModal() {
        const mustWinToggle = document.getElementById("mustWinByBidToggle");
        if (mustWinToggle) mustWinToggle.checked = JSON.parse(localStorage.getItem(MUST_WIN_BY_BID_KEY) || "false");
        const proToggleModal = document.getElementById("proModeToggleModal");
        if (proToggleModal) proToggleModal.checked = JSON.parse(localStorage.getItem(PRO_MODE_KEY) || "false");
        document.getElementById('editPresetsContainerModal')?.classList.remove('hidden'); // Always show
        openModal("settingsModal");
      }
      function closeSettingsModal() { closeModal("settingsModal"); }
      function openAboutModal() { openModal("aboutModal"); }
      function closeAboutModal() { closeModal("aboutModal"); }
      function openStatisticsModal() { renderStatisticsContent(); openModal("statisticsModal"); }
      function closeStatisticsModal() { closeModal("statisticsModal"); document.getElementById("statisticsModalContent").innerHTML = "";}
      function openViewSavedGameModal() { openModal("viewSavedGameModal"); }
      function closeViewSavedGameModal() { closeModal("viewSavedGameModal"); openModal("savedGamesModal"); } // Reopen parent

      // --- Game Actions & Logic ---
      function handleCheatFlag() {
  if (!state.biddingTeam) return;  // nothing to flag

  const teamName = state.biddingTeam === "us"
      ? (state.usTeamName || "Us")
      : (state.demTeamName || "Dem");

  openConfirmationModal(
    `Flag ${teamName} for table-talk? They will lose their bid.`,
    () => { // YES
      applyCheatPenaltyRound(state.biddingTeam);
      closeConfirmationModal();
      showSaveIndicator("Penalty applied");
    },
    closeConfirmationModal // NO
  );
}

function applyCheatPenaltyRound(flaggedTeam) {
  // Get current state values
  const { biddingTeam, bidAmount, rounds, usTeamName, demTeamName } = state;
  if (!biddingTeam || !bidAmount) return;
  const numericBid = Number(bidAmount);
  const lastTotals = rounds.length ? rounds[rounds.length - 1].runningTotals : { us: 0, dem: 0 };
  let usEarned = 0, demEarned = 0;
  if (flaggedTeam === "us") {
    usEarned = -numericBid;
    demEarned = 0;
  } else {
    usEarned = 0;
    demEarned = -numericBid;
  }
  const newTotals = { us: lastTotals.us + usEarned, dem: lastTotals.dem + demEarned };
  const newRound = {
    biddingTeam,
    bidAmount: numericBid,
    usPoints: usEarned,
    demPoints: demEarned,
    runningTotals: newTotals,
    usTeamNameOnRound: usTeamName || "Us",
    demTeamNameOnRound: demTeamName || "Dem",
    penalty: "cheat"
  };
  const updatedRounds = [...rounds, newRound];

  // Check for game over
  const mustWinByBid = JSON.parse(localStorage.getItem(MUST_WIN_BY_BID_KEY) || "false");
  let gameFinished = false, theWinner = null, victoryMethod = "Penalty: Lost Bid";
  if (Math.abs(newTotals.us - newTotals.dem) >= 1000) {
    gameFinished = true; theWinner = newTotals.us > newTotals.dem ? "us" : "dem"; victoryMethod = "1000 Point Spread";
  } else if ((biddingTeam === "us" && usEarned < 0 && newTotals.dem >= 500) || (biddingTeam === "dem" && demEarned < 0 && newTotals.us >= 500)) {
    if (!mustWinByBid) { gameFinished = true; theWinner = biddingTeam === "us" ? "dem" : "us"; victoryMethod = "Set Other Team"; }
  } else if (newTotals.us >= 500 || newTotals.dem >= 500) {
    if (mustWinByBid) {
      // Only possible if the penalized team still wins by making their bid, which can't happen here
    } else {
      gameFinished = true; theWinner = newTotals.us >= newTotals.dem ? "us" : (newTotals.dem > newTotals.us ? "dem" : null);
      if (theWinner === null && newTotals.us === newTotals.dem) victoryMethod = "Tie at 500+";
      else if (theWinner) victoryMethod = "Reached 500+";
    }
  }
  let finalAccumulated = state.accumulatedTime;
  if (state.startTime !== null && !gameFinished) { /* Time continues */ }
  else if (state.startTime !== null && gameFinished) { finalAccumulated += Date.now() - state.startTime; }

  updateState({
    rounds: updatedRounds,
    undoneRounds: [],
    gameOver: gameFinished,
    winner: theWinner,
    victoryMethod,
    biddingTeam: "",
    bidAmount: "",
    showCustomBid: false,
    customBidValue: "",
    enterBidderPoints: false,
    error: "",
    accumulatedTime: finalAccumulated,
    startTime: gameFinished ? null : state.startTime,
    pendingPenalty: null
  });
  if (gameFinished && theWinner) updateTeamsStatsOnGameEnd(theWinner);
  saveCurrentGameState();
}

      function handleTeamClick(team) {
        if (state.gameOver) return;
        if (state.biddingTeam === team) { // Click active team to deselect
          state.savedScoreInputStates[team] = { bidAmount: state.bidAmount, customBidValue: state.customBidValue, showCustomBid: state.showCustomBid, enterBidderPoints: state.enterBidderPoints, error: state.error };
          updateState({ biddingTeam: "", bidAmount: "", showCustomBid: false, customBidValue: "", enterBidderPoints: false, error: ""});
        } else { // Select a new team
          state.savedScoreInputStates[team === "us" ? "dem" : "us"] = null; // Clear other team's saved input
          let newTeamState = { biddingTeam: team, bidAmount: "", showCustomBid: false, customBidValue: "", enterBidderPoints: false, error: "" };
          if (state.savedScoreInputStates[team]) { // Restore if previously selected
            newTeamState = { ...newTeamState, ...state.savedScoreInputStates[team] };
          }
          updateState(newTeamState);
        }
        ephemeralCustomBid = ""; ephemeralPoints = ""; // Clear ephemeral inputs on team switch
      }
      function handleBidSelect(bid) {
        if (bid === "other") {
          updateState({ showCustomBid: true, bidAmount: "", customBidValue: ephemeralCustomBid }); // Keep current custom bid if switching back
        } else {
          updateState({ showCustomBid: false, bidAmount: String(bid), customBidValue: "" });
        }
        // Update last bid info only if a numeric bid is made or custom bid is valid
        const bidVal = (bid === "other" && validateBid(state.customBidValue)==="") ? state.customBidValue : (bid !== "other" ? String(bid) : null);
        if (bidVal) updateState({ lastBidAmount: bidVal, lastBidTeam: state.biddingTeam });
        else updateState({ lastBidAmount: null, lastBidTeam: null}); // Clear if "other" is selected with no valid custom bid yet

        // Save current bid selection to localStorage
        saveCurrentGameState();
      }
      // numbers that are technically "valid JSON" but we *don't* want to trigger a re-render for
const BLOCKED_BIDS = new Set([5, 10, 15]);

function handleCustomBidChange(e) {
  const valStr = e.target.value.trim();   // what the user just typed
  ephemeralCustomBid = valStr;            // persist while they're editing

  /* 1 ▸ don't redraw yet if…
        – the bid isn't valid JSON-wise  OR
        – it's one of the blocked small bids                       */
  if (validateBid(valStr) !== "" || BLOCKED_BIDS.has(+valStr)) return;

  /* 2 ▸ number is good and allowed → commit to state
        (this will re-render exactly once, keeping focus alive)    */
  updateState({
    customBidValue : valStr,
    bidAmount      : valStr,
    lastBidAmount  : valStr,
    lastBidTeam    : state.biddingTeam
  });
}

      function handleBiddingPointsToggle(isBiddingTeamPoints) {
        ephemeralPoints = ""; // Clear ephemeral points input
        updateState({ enterBidderPoints: isBiddingTeamPoints });
      }
      function handleFormSubmit(e, skipZeroCheck = false) {
        e.preventDefault();
        const { biddingTeam, bidAmount, rounds, enterBidderPoints, usTeamName, demTeamName } = state;
        const pointsInputEl = document.getElementById("pointsInput");
        if (!pointsInputEl) { updateState({ error: "Points input not found." }); return; }
        const pointsVal = pointsInputEl.value;

        if (!biddingTeam || !bidAmount) { updateState({ error: "Please select bid amount." }); return; }
        const bidError = validateBid(bidAmount);
        const pointsError = validatePoints(pointsVal);
        if (bidError || pointsError) { updateState({ error: bidError || pointsError }); return; }

        const numericBid = Number(bidAmount);
        const numericPoints = Number(pointsVal);

        if (!skipZeroCheck && numericPoints === 0) {
  const enteredForNonBidder = !state.enterBidderPoints;   // true ⇢ '0' belonged to non-bid team

  openZeroPointsModal(chosen => {
    /* commit() will run once the DOM is ready */
    const commit = () => {
  const freshInput = document.getElementById("pointsInput");
  if (freshInput) freshInput.value = String(chosen);

  /* second arg ›› skipZeroCheck = true */
  handleFormSubmit(new Event("submit"), /* skipZeroCheck */ true);
};

    /* if the '0' was for the non-bidding team we must flip the toggle first,
       which triggers a re-render → wait one tick before commit()            */
       if (enteredForNonBidder && chosen !== 0 && state.enterBidderPoints === false) {
        handleBiddingPointsToggle(true);     // causes one re-render
        setTimeout(commit, 0);               // run after new DOM appears
    } else {
        commit();                            // no toggle needed
    }
  });

  return;                                 // pause main handler until modal choice
}

        if (rounds.length === 0 && state.startTime === null) updateState({ startTime: Date.now() });

        let usEarned = 0, demEarned = 0;
        const nonBiddingTeamTotal = 180; // Standard total points in a hand excluding Rook

        if (numericPoints === 360) { // Special 360 case (usually means all points + Rook)
            if (enterBidderPoints) { // Bidding team claims 360
                biddingTeam === "us" ? (usEarned = 360, demEarned = 0) : (demEarned = 360, usEarned = 0);
            } else { // Non-bidding team claims 360
                biddingTeam === "us" ? (usEarned = -numericBid, demEarned = 360) : (demEarned = -numericBid, usEarned = 360);
            }
        } else { // Standard point distribution
            if (enterBidderPoints) { // Points entered for bidding team
                biddingTeam === "us" ? (usEarned = numericPoints, demEarned = nonBiddingTeamTotal - numericPoints) : (demEarned = numericPoints, usEarned = nonBiddingTeamTotal - numericPoints);
            } else { // Points entered for non-bidding team
                biddingTeam === "us" ? (demEarned = numericPoints, usEarned = nonBiddingTeamTotal - numericPoints) : (usEarned = numericPoints, demEarned = nonBiddingTeamTotal - numericPoints);
            }
            // Apply penalty if bid not met
            if (state.pendingPenalty && state.pendingPenalty.type === "cheat") {
    if (state.pendingPenalty.team === "us")   usEarned  = -numericBid;
    else                                      demEarned = -numericBid;
}
            if (biddingTeam === "us" && usEarned < numericBid) usEarned = -numericBid;
            else if (biddingTeam === "dem" && demEarned < numericBid) demEarned = -numericBid;
        }

        const lastTotals = rounds.length ? rounds[rounds.length - 1].runningTotals : { us: 0, dem: 0 };
        const newTotals = { us: lastTotals.us + usEarned, dem: lastTotals.dem + demEarned };
        const newRound = { biddingTeam, bidAmount: numericBid, usPoints: usEarned, demPoints: demEarned, runningTotals: newTotals, usTeamNameOnRound: usTeamName || "Us", demTeamNameOnRound: demTeamName || "Dem" };
        const updatedRounds = [...rounds, newRound];

        const mustWinByBid = JSON.parse(localStorage.getItem(MUST_WIN_BY_BID_KEY) || "false");
        let gameFinished = false, theWinner = null, victoryMethod = "Won on Bid";

        if (Math.abs(newTotals.us - newTotals.dem) >= 1000) {
            gameFinished = true; theWinner = newTotals.us > newTotals.dem ? "us" : "dem"; victoryMethod = "1000 Point Spread";
        } else if ((biddingTeam === "us" && usEarned < 0 && newTotals.dem >= 500) || (biddingTeam === "dem" && demEarned < 0 && newTotals.us >= 500)) {
            if (!mustWinByBid) { gameFinished = true; theWinner = biddingTeam === "us" ? "dem" : "us"; victoryMethod = "Set Other Team"; }
        } else if (newTotals.us >= 500 || newTotals.dem >= 500) {
            if (mustWinByBid) {
                if ((biddingTeam === "us" && newTotals.us >= 500 && usEarned >= numericBid) || (biddingTeam === "dem" && newTotals.dem >= 500 && demEarned >= numericBid)) {
                    gameFinished = true; theWinner = biddingTeam; victoryMethod = "Won on Bid";
                }
            } else {
                gameFinished = true; theWinner = newTotals.us >= newTotals.dem ? "us" : (newTotals.dem > newTotals.us ? "dem" : null /* Tie check, rare */);
                 if (theWinner === null && newTotals.us === newTotals.dem) victoryMethod = "Tie at 500+"; // Handle tie
                 else if (theWinner) victoryMethod = "Reached 500+";
            }
        }
        
        ephemeralCustomBid = ""; ephemeralPoints = "";
        let finalAccumulated = state.accumulatedTime;
        if (state.startTime !== null && !gameFinished) { /* Time continues */ }
        else if (state.startTime !== null && gameFinished) { finalAccumulated += Date.now() - state.startTime; }

        updateState({
            rounds: updatedRounds, undoneRounds: [], gameOver: gameFinished, winner: theWinner, victoryMethod,
            biddingTeam: "", bidAmount: "", showCustomBid: false, customBidValue: "", enterBidderPoints: false, error: "",
            accumulatedTime: finalAccumulated, startTime: gameFinished ? null : state.startTime, pendingPenalty: null 
        });
        if (gameFinished && theWinner) updateTeamsStatsOnGameEnd(theWinner);
        saveCurrentGameState();
      }
      function handleUndo() {
        if (!state.rounds.length) return;
        const lastRound = state.rounds[state.rounds.length - 1];
        const newRounds = state.rounds.slice(0, -1);
        const newUndoneRounds = [...state.undoneRounds, lastRound];
        let newLastBid = null, newLastBidTeam = null;
        if (newRounds.length > 0) {
            newLastBid = String(newRounds[newRounds.length-1].bidAmount);
            newLastBidTeam = newRounds[newRounds.length-1].biddingTeam;
        }
        updateState({ rounds: newRounds, undoneRounds: newUndoneRounds, gameOver: false, winner: null, victoryMethod: null, lastBidAmount: newLastBid, lastBidTeam: newLastBidTeam });
        saveCurrentGameState();
      }
      function handleRedo() {
        if (!state.undoneRounds.length) return;
        const redoRound = state.undoneRounds[state.undoneRounds.length - 1];
        const newRounds = [...state.rounds, redoRound];
        const newUndoneRounds = state.undoneRounds.slice(0, -1);
        
        // Re-check game over condition based on the new last round
        const lastTotals = newRounds[newRounds.length - 1].runningTotals;
        let gameOver = false, winner = null, victoryMethod = null;
        const mustWinByBid = JSON.parse(localStorage.getItem(MUST_WIN_BY_BID_KEY) || "false");

        if (Math.abs(lastTotals.us - lastTotals.dem) >= 1000) {
            gameOver = true; winner = lastTotals.us > lastTotals.dem ? "us" : "dem"; victoryMethod = "1000 Point Spread";
        } else if ((redoRound.biddingTeam === "us" && redoRound.usPoints < 0 && lastTotals.dem >= 500) || 
                   (redoRound.biddingTeam === "dem" && redoRound.demPoints < 0 && lastTotals.us >= 500)) {
            if (!mustWinByBid) { gameOver = true; winner = redoRound.biddingTeam === "us" ? "dem" : "us"; victoryMethod = "Set Other Team"; }
        } else if (lastTotals.us >= 500 || lastTotals.dem >= 500) {
            if (mustWinByBid) {
                if ((redoRound.biddingTeam === "us" && lastTotals.us >= 500 && redoRound.usPoints >= redoRound.bidAmount) ||
                    (redoRound.biddingTeam === "dem" && lastTotals.dem >= 500 && redoRound.demPoints >= redoRound.bidAmount)) {
                    gameOver = true; winner = redoRound.biddingTeam; victoryMethod = "Won on Bid";
                }
            } else {
                gameOver = true; winner = lastTotals.us >= lastTotals.dem ? "us" : (lastTotals.dem > lastTotals.us ? "dem" : null);
                if (winner === null && lastTotals.us === lastTotals.dem) victoryMethod = "Tie at 500+";
                else if(winner) victoryMethod = "Reached 500+";
            }
        }

        updateState({ rounds: newRounds, undoneRounds: newUndoneRounds, gameOver, winner, victoryMethod, lastBidAmount: String(redoRound.bidAmount), lastBidTeam: redoRound.biddingTeam });
        saveCurrentGameState();
      }
      function handleNewGame() {
  openConfirmationModal(
    "Start a new game? Unsaved progress will be lost.",
    () => {
      closeTeamSelectionModal();
      resetGame();
      closeConfirmationModal();
    },
    closeConfirmationModal
  );
}
function hideGameOverOverlay() {
  const overlay = document.querySelector('[data-overlay="gameover"]');
  if (overlay) overlay.classList.add('hidden');
}

function handleGameOverSaveClick(e) {
  if (e) e.preventDefault();
  hideGameOverOverlay();
  pendingGameAction = "save";
  openTeamSelectionModal();
}

      function handleManualSaveGame() { // Called after team names confirmed or if already set
        if (!state.usTeamName || !state.demTeamName) {
          pendingGameAction = "save"; openTeamSelectionModal(); return;
        }
        if (!state.rounds.length) return;

        let finalAccumulated = state.accumulatedTime;
        if (state.startTime !== null) finalAccumulated += Date.now() - state.startTime;

        const lastRoundTotals = state.rounds.length ? state.rounds[state.rounds.length - 1].runningTotals : { us: 0, dem: 0 };
        const gameObj = {
            usTeamName: state.usTeamName, demTeamName: state.demTeamName,
            rounds: state.rounds, finalScore: lastRoundTotals,
            winner: state.winner, victoryMethod: state.victoryMethod,
            timestamp: new Date().toISOString(), durationMs: finalAccumulated,
            // Simplified playerStats, more complex stats are in general statistics
            playerStats: { 
                [state.usTeamName]: { totalPoints: lastRoundTotals.us, wins: state.winner === "us" ? 1 : 0 },
                [state.demTeamName]: { totalPoints: lastRoundTotals.dem, wins: state.winner === "dem" ? 1 : 0 }
            }
        };
        const savedGames = getLocalStorage("savedGames");
        savedGames.push(gameObj);
        setLocalStorage("savedGames", savedGames);
        showSaveIndicator("Game Saved!");
        resetGame(); // Resets state and clears active game from storage
        confettiTriggered = false;
        pendingGameAction = null;
      }
      function handleFreezerGame() {
        if (state.gameOver || !state.rounds.length) {
          alert("No active game to freeze."); return;
        }
        if (!state.usTeamName || !state.demTeamName) {
          pendingGameAction = "freeze"; openTeamSelectionModal(); return;
        }
        confirmFreeze(); // Ask for confirmation
      }
      function confirmFreeze() {
         openConfirmationModal(
            "Freeze this game? It will be moved to Freezer Games and current game will reset.",
            () => { freezeCurrentGame(); closeConfirmationModal(); closeMenuOverlay(); },
            closeConfirmationModal
        );
      }
      function freezeCurrentGame() {
        let finalAccumulated = state.accumulatedTime;
        if (state.startTime !== null) finalAccumulated += Date.now() - state.startTime;
        const finalScore = state.rounds.length ? state.rounds[state.rounds.length-1].runningTotals : {us:0, dem:0};
        const lastRound = state.rounds.length ? state.rounds[state.rounds.length-1] : {};

        const frozenGame = {
            name: `FROZEN-${new Date().toLocaleTimeString()}`, // More readable name
            usName: state.usTeamName, demName: state.demTeamName,
            finalScore, // Current scores when frozen
            lastBid: lastRound.bidAmount ? `${lastRound.bidAmount} (${lastRound.biddingTeam === "us" ? state.usTeamName : state.demTeamName})` : "N/A",
            winner: null, victoryMethod: null, // Game is not over
            rounds: state.rounds, timestamp: new Date().toISOString(),
            accumulatedTime: finalAccumulated,
            // Store necessary state to resume
            biddingTeam: state.biddingTeam, bidAmount: state.bidAmount,
            customBidValue: state.customBidValue, showCustomBid: state.showCustomBid,
            enterBidderPoints: state.enterBidderPoints, lastBidAmount: state.lastBidAmount, lastBidTeam: state.lastBidTeam
        };
        const freezerGames = getLocalStorage("freezerGames");
        freezerGames.unshift(frozenGame); // Add to beginning
        setLocalStorage("freezerGames", freezerGames);
        showSaveIndicator("Game Frozen!");
        resetGame(); // Resets state and clears active game
        pendingGameAction = null;
      }
      function loadFreezerGame(index) {
        const freezerGames = getLocalStorage("freezerGames");
        const chosen = freezerGames[index];
        if (!chosen) return;
        openConfirmationModal(
          `Load frozen game "${chosen.name || 'Untitled'}"? Current game will be overwritten.`,
          () => {
            closeConfirmationModal();
            // Restore all relevant game state aspects
            updateState({
                rounds: chosen.rounds || [],
                gameOver: false, // Frozen games are not over
                winner: null, victoryMethod: null,
                biddingTeam: chosen.biddingTeam || "",
                bidAmount: chosen.bidAmount || "",
                showCustomBid: chosen.showCustomBid || false,
                customBidValue: chosen.customBidValue || "",
                enterBidderPoints: chosen.enterBidderPoints || false,
                error: "", // Clear any previous error
                lastBidAmount: chosen.lastBidAmount || null,
                lastBidTeam: chosen.lastBidTeam || null,
                usTeamName: chosen.usName || "Us",
                demTeamName: chosen.demName || "Dem",
                accumulatedTime: chosen.accumulatedTime || 0,
                startTime: Date.now(), // Restart timer
                showWinProbability: JSON.parse(localStorage.getItem(PRO_MODE_KEY)) || false,
                undoneRounds: [] // Clear any undone rounds from previous state
            });
            freezerGames.splice(index, 1); // Remove from freezer
            setLocalStorage("freezerGames", freezerGames);
            closeSavedGamesModal();
            saveCurrentGameState(); // Save the now active game
            confettiTriggered = false;
          },
          closeConfirmationModal
        );
      }
      function viewSavedGame(originalIndex) { // originalIndex is from the full savedGames list
        const savedGames = getLocalStorage("savedGames"); // Get the full list
        // Find the actual game object by its original index if filtering/sorting was applied
        // This requires the renderSavedGames to pass the original index or unique ID.
        // For simplicity, assuming originalIndex is correct for the current display of `savedGames`.
        // A robust solution would involve passing a game ID if the list is dynamically filtered/sorted.
        // Let's assume `renderSavedGames` provides an index that's valid for `getLocalStorage("savedGames")[index]`
        const chosen = savedGames[originalIndex];

        if (!chosen) return;
        document.getElementById("viewSavedGameDetails").innerHTML = renderReadOnlyGameDetails(chosen);
        openViewSavedGameModal();
      }
      function deleteGame(storageKey, index, descriptor) {
        const items = getLocalStorage(storageKey);
        openConfirmationModal(`Delete this ${descriptor}?`, () => {
          items.splice(index, 1);
          setLocalStorage(storageKey, items);
          if (storageKey === "savedGames") recalcTeamsStats(); // Only if deleting a completed game
          closeConfirmationModal();
          // Re-render the list in the modal
          if (document.getElementById("savedGamesModal") && !document.getElementById("savedGamesModal").classList.contains("hidden")) {
            updateGamesCount();
            renderGamesWithFilter();
          }
        }, closeConfirmationModal);
      }
      function deleteSavedGame(index) { deleteGame("savedGames", index, "completed game"); }
      function deleteFreezerGame(index) { deleteGame("freezerGames", index, "frozen game"); }
      
      // --- Settings & Pro Mode ---
      function saveSettings() {
        const mustWinToggle = document.getElementById("mustWinByBidToggle");
        if (mustWinToggle) localStorage.setItem(MUST_WIN_BY_BID_KEY, mustWinToggle.checked);
        showSaveIndicator("Settings Saved");
      }
      function updateProModeUI(isProMode) {
        document.getElementById('editPresetsContainerModal')?.classList.remove('hidden'); // Always show
        const proToggleModal = document.getElementById("proModeToggleModal");
        if (proToggleModal) proToggleModal.checked = isProMode;
        updateState({ showWinProbability: isProMode }); // Update live state
      }
      function toggleProMode(checkbox) {
        const isPro = checkbox.checked;
        localStorage.setItem(PRO_MODE_KEY, isPro);
        updateProModeUI(isPro);
        saveCurrentGameState(); // Save state with new pro mode setting
      }

      // --- Validation ---
      function validateBid(bidStr) {
        const bidNum = Number(bidStr);
        if (isNaN(bidNum)) return "Bid must be a number.";
        if (bidNum <= 0) return "Bid must be > 0.";
        if (bidNum % 5 !== 0) return "Bid must be multiple of 5.";
        if (bidNum > 360) return "Bid max 360.";
        return "";
      }
      function validatePoints(pointsStr) {
        const pointsNum = Number(pointsStr);
        if (isNaN(pointsNum)) return "Points must be a number.";
        if (pointsNum % 5 !== 0) return "Points must be multiple of 5.";
        if (pointsNum !== 360 && (pointsNum < 0 || pointsNum > 180)) return "Points 0-180 or 360.";
        return "";
      }
      
      // --- Misc UI & Utility ---
      function showVersionNum() {
        alert("Version 1.4.5 adds an option to select: 'must win game by taking bid', a 'redo' button, improved 0-point handling, new cheating penalty and sandbag detection features, enhanced win probability calculations and visual polish, and various bug fixes.");
      }
      function formatDuration(ms) {
        if (!ms || ms < 0) return "0:00";
        const secs = Math.floor(ms / 1000);
        const mins = Math.floor(secs / 60);
        const hrs = Math.floor(mins / 60);
        const s = secs % 60;
        const m = mins % 60;
        return `${hrs > 0 ? hrs + ':' : ''}${hrs > 0 && m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
      }
      function populateTeamSelects() {
        const teamsObj = getTeamsObject();
        const sortedNames = Object.keys(teamsObj).filter(name => name !== "Us" && name !== "Dem").sort((a,b) => a.localeCompare(b));
        const usSelect = document.getElementById("selectUsTeam");
        const demSelect = document.getElementById("selectDemTeam");
        [usSelect, demSelect].forEach(sel => {
            sel.innerHTML = '<option value="">-- Select or Add --</option>'; // Default empty option
            sortedNames.forEach(name => sel.add(new Option(name, name)));
            sel.add(new Option("Add New Team...", "NEW_TEAM"));
        });
        // Set current team names if they exist and are not "Us"/"Dem"
        if (state.usTeamName && state.usTeamName !== "Us" && sortedNames.includes(state.usTeamName)) usSelect.value = state.usTeamName;
        if (state.demTeamName && state.demTeamName !== "Dem" && sortedNames.includes(state.demTeamName)) demSelect.value = state.demTeamName;

        // Show/hide new team name input based on selection
        const handleSelectChange = (selectEl, inputElId) => {
            document.getElementById(inputElId).classList.toggle("hidden", selectEl.value !== "NEW_TEAM");
        };
        usSelect.onchange = () => handleSelectChange(usSelect, "newUsTeamName");
        demSelect.onchange = () => handleSelectChange(demSelect, "newDemTeamName");
        // Initial visibility check
        handleSelectChange(usSelect, "newUsTeamName");
        handleSelectChange(demSelect, "newDemTeamName");
      }
      function handleTeamSelectionSubmit(e) {
        e.preventDefault();
        const getTeamName = (selId, inputId) => {
            const selVal = document.getElementById(selId).value;
            return selVal === "NEW_TEAM" ? document.getElementById(inputId).value.trim() : selVal;
        };
        let finalUs = getTeamName("selectUsTeam", "newUsTeamName");
        let finalDem = getTeamName("selectDemTeam", "newDemTeamName");

        if (!finalUs && !finalDem && (state.usTeamName && state.demTeamName)) { // If user cancels with existing names, keep them
            finalUs = state.usTeamName;
            finalDem = state.demTeamName;
        } else { // Validate new/selected names
            if (!finalUs || finalUs === "NEW_TEAM") { alert("Please provide a name for Team 'Us'."); return; }
            if (!finalDem || finalDem === "NEW_TEAM") { alert("Please provide a name for Team 'Dem'."); return; }
            if (finalUs === finalDem) { alert("Team names must be different."); return; }
        }

        addTeamIfNotExists(finalUs); addTeamIfNotExists(finalDem);
        updateState({ usTeamName: finalUs, demTeamName: finalDem });
        saveCurrentGameState();
        closeTeamSelectionModal();
        if (pendingGameAction === "freeze") { confirmFreeze(); }
        else if (pendingGameAction === "save") { handleManualSaveGame(); }
        pendingGameAction = null;
      }
      function getDeviceDetails() {
        let appVersion = "N/A";
        try {
            const verEl = document.querySelector('.absolute.top-0.right-0 p');
            if (verEl && verEl.textContent.includes('version')) appVersion = verEl.textContent.trim();
        } catch (e) { console.warn("Could not get app version:", e); }

        let fbStatus = "N/A", fbUserId = "N/A", fbIsAnon = "N/A";
        if (window.firebaseAuth) {
            fbStatus = window.firebaseReady ? "Ready" : "Not Ready/Offline";
            if (window.firebaseAuth.currentUser) {
                fbUserId = window.firebaseAuth.currentUser.uid;
                fbIsAnon = String(window.firebaseAuth.currentUser.isAnonymous);
            }
        }
        return `User Agent: ${navigator.userAgent}\nScreen: ${window.innerWidth}x${window.innerHeight} (DPR: ${window.devicePixelRatio})\nApp Version: ${appVersion}\nDark Mode: ${document.documentElement.classList.contains('dark')}\nPro Mode: ${localStorage.getItem(PRO_MODE_KEY) === 'true'}\nFirebase: ${fbStatus} (User: ${fbUserId}, Anon: ${fbIsAnon})\nTimestamp: ${new Date().toISOString()}`;
      }
      function handleBugReportClick() {
          const recipient = "heinonenmh@gmail.com";
          const subject = "Rook Score App - Bug Report";
          const deviceDetails = getDeviceDetails();
          let appStateString = "Could not retrieve app state.";
          try {
            appStateString = [
              `Teams: ${state.usTeamName || "Us"} vs ${state.demTeamName || "Dem"}`,
              `Scores: Us ${state.rounds?.[state.rounds.length-1]?.runningTotals?.us ?? 0} - Dem ${state.rounds?.[state.rounds.length-1]?.runningTotals?.dem ?? 0}`,
              `Rounds played: ${state.rounds?.length ?? 0}`,
              `Game Over: ${state.gameOver ? "Yes" : "No"}`,
              `Winner: ${state.winner || "N/A"}`,
              `Victory Method: ${state.victoryMethod || "N/A"}`
            ].join('\n');
          } catch (e) {
            appStateString = `Error summarizing state: ${e.message}`;
          }
          const body = `Please describe the bug:\n[ ** Enter Description Here ** ]\n\n--- Device & App Info ---\n${deviceDetails}\n\n--- App State ---\n${appStateString}\n\n(Review before sending)`;
          const mailtoLink = `mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          if (mailtoLink.length > 2000) {
              alert("Bug report details are very long. Please copy the following details manually into your email client if the body is incomplete.");
              console.log("--- COPY BUG REPORT DETAILS BELOW ---");
              console.log(body); // Log to console as fallback
          }
          window.location.href = mailtoLink;
      }

      // --- Rendering Functions ---
      // (renderApp, renderTeamCard, renderRoundCard, renderErrorAlert, renderScoreInputCard, renderPointsInput, renderHistoryCard, renderGameOverOverlay, renderReadOnlyGameDetails, renderSavedGames, renderFreezerGames, renderStatisticsContent, renderTeamStatsTable)
      // These are substantial and involve generating HTML. They are defined below.
      function renderApp() {
        const { error, rounds, bidAmount, showCustomBid, biddingTeam, customBidValue, gameOver, lastBidAmount, lastBidTeam } = state;
        const totals = rounds.reduce((acc, r) => ({ us: acc.us + (r.usPoints || 0), dem: acc.dem + (r.demPoints || 0) }), { us: 0, dem: 0 });
        const roundNumber = rounds.length + 1;
        
        let lastBidDisplayHtml = "";
        // Show "Current Bid" if a bid is being selected
        if (biddingTeam && (bidAmount || (showCustomBid && customBidValue))) {
            const currentBidDisplayAmount = bidAmount || customBidValue;
            const currentBiddingTeamName = biddingTeam === "us" ? (state.usTeamName || "Us") : (state.demTeamName || "Dem");
            const arrow = biddingTeam === "us" ? "←" : "→";
            const teamColor = biddingTeam === "us" ? 'var(--primary-color)' : 'var(--accent-color)';
            if (validateBid(currentBidDisplayAmount) === "") { // Only display if valid
                lastBidDisplayHtml = `<div class=\"mt-1 text-xs\">Current Bid: <span class=\"font-semibold\" style=\"color: ${teamColor};\">${currentBiddingTeamName}</span><br><span class=\"inline-block mt-0.5 font-bold\">${currentBidDisplayAmount} <span>${arrow}</span></span></div>`;
            }
        }
        // If not, show "Last Bid" from the last completed round
        else if (state.rounds.length > 0) {
            const lastRound = state.rounds[state.rounds.length - 1];
            const lastBidAmount = lastRound.bidAmount;
            const lastBidTeam = lastRound.biddingTeam;
            const teamName = lastBidTeam === "us" ? (state.usTeamName || "Us") : (state.demTeamName || "Dem");
            const arrow = lastBidTeam === "us" ? "←" : "→";
            const teamColor = lastBidTeam === "us" ? 'var(--primary-color)' : 'var(--accent-color)';
            lastBidDisplayHtml = `<div class=\"mt-1 text-xs\">Last Bid: <span class=\"font-semibold\" style=\"color: ${teamColor};\">${teamName}</span><br><span class=\"inline-block mt-0.5 font-bold\">${lastBidAmount} <span>${arrow}</span></span></div>`;
        }


        document.getElementById("app").innerHTML = `
          <div class="text-center space-y-2">
            <h1 class="font-extrabold text-5xl sm:text-6xl text-gray-800 dark:text-white">Rook!</h1>
            <p class="text-md sm:text-lg text-gray-600 dark:text-white">Tap a team to start a bid!</p>
          </div>
          <div class="flex flex-row gap-3 flex-wrap justify-center items-stretch">
            ${renderTeamCard("us", totals.us)}
            ${renderRoundCard(roundNumber, lastBidDisplayHtml)}
            ${renderTeamCard("dem", totals.dem)}
          </div>
          ${error ? `<div>${renderErrorAlert(error)}</div>` : ""}
          ${renderScoreInputCard()}
          ${renderHistoryCard()}
          ${renderGameOverOverlay()}
        `;
        if (gameOver && !confettiTriggered) {
          confettiTriggered = true;
          if (typeof confetti === 'function') confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
        }
      }
      function renderTeamCard(teamKey, score) {
        const isSelected = state.biddingTeam === teamKey;
        const teamLabel = teamKey === "us" ? (state.usTeamName || "Us") : (state.demTeamName || "Dem");
        const colorClass = teamKey === "us" ? "bg-primary" : "bg-accent";
        const selectedEffect = isSelected ? "sunken-selected" : "";
        let winProbDisplay = "";
        if (state.showWinProbability && !state.gameOver && state.rounds.length > 0) {
          const winProb = calculateWinProbability(state, getLocalStorage("savedGames"));
          const prob = teamKey === "us" ? winProb.us : winProb.dem;
          const teamColorVar = teamKey === "us" ? "var(--primary-color)" : "var(--accent-color)";
          const brightness = isSelected ? "brightness(0.7)" : "brightness(0.85)"; // Darken more when selected
          // Inner div for probability text to ensure z-index works with sunken-selected's ::after
          winProbDisplay = `
            <div class="mt-1 text-xs rounded-full px-2 py-1 relative" style="background-color: ${teamColorVar}; filter: ${brightness};">
              <span class="relative font-medium" style="color: #FFF; z-index: 1;">Win: ${prob.toFixed(1)}%</span>
            </div>`;
        }
        return `
          <button type="button"
    class="${colorClass} ${selectedEffect} threed text-white cursor-pointer transition-all rounded-xl shadow-md flex flex-col items-center justify-center flex-1 min-w-[calc(33%-1rem)] sm:min-w-0 w-auto h-32 p-2"
    onclick="handleTeamClick('${teamKey}')"
    aria-pressed="${isSelected}" aria-label="Select ${teamLabel}">
    <div class="text-center">
      <h2 class="text-base sm:text-xl font-semibold truncate max-w-[100px] sm:max-w-[120px]">${teamLabel}</h2>
      <p class="text-2xl font-bold">${score}</p>
      ${winProbDisplay}
    </div>
  </button>`;
      }
      function renderRoundCard(roundNumber, lastBidDisplayHtml) {
        return `
          <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow threed flex flex-col items-center justify-center p-3 flex-1 min-w-[calc(33%-1rem)] sm:min-w-0 w-auto h-32">
            <div class="text-center space-y-1">
              <h2 class="text-xl font-bold text-gray-700 dark:text-white">Round</h2>
              <p class="text-2xl font-extrabold text-gray-900 dark:text-white">${roundNumber}</p>
              ${lastBidDisplayHtml}
            </div>
          </div>`;
      }
      function renderErrorAlert(errorMessage) {
        return `<div role="alert" class="flex items-center border border-red-400 rounded-xl p-4 bg-red-50 text-red-700 space-x-3 dark:bg-red-900/50 dark:border-red-600 dark:text-red-300">${Icons.AlertCircle}<div class="flex-1">${errorMessage}</div></div>`;
      }
      function renderScoreInputCard() {
        const { biddingTeam, bidAmount, showCustomBid, customBidValue, rounds, gameOver, undoneRounds, pendingPenalty } = state;
        if (gameOver || !biddingTeam) { scoreCardHasAnimated = false; return ""; }
        const fadeClass = scoreCardHasAnimated ? "" : "animate-fadeIn";
        scoreCardHasAnimated = true;
        const hasBid = bidAmount || (showCustomBid && validateBid(customBidValue) === "");
        const biddingTeamDisplayName = biddingTeam === "us" ? (state.usTeamName || "Us") : (state.demTeamName || "Dem");
        const focusRingColor = biddingTeam === "us" ? "focus:ring-blue-500 dark:focus:ring-blue-400" : "focus:ring-red-500 dark:focus:ring-red-400";
        const penaltyActive = pendingPenalty && pendingPenalty.team === biddingTeam && pendingPenalty.type === "cheat";
        const penaltyBtnClass = penaltyActive
          ? "flex items-center border border-orange-400 rounded px-2 py-1 text-sm text-orange-700 bg-orange-100 hover:bg-orange-200 transition focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-orange-900/60 dark:text-orange-300 threed"
          : "flex items-center border border-gray-400 rounded px-2 py-1 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 transition focus:outline-none focus:ring-2 focus:ring-gray-500 dark:bg-gray-800/50 dark:text-gray-300 threed";
        const penaltyBtnOnClick = penaltyActive ? 'undoPenaltyFlag()' : 'handleCheatFlag()';
        return `
          <div class="${fadeClass} bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow">
            <div class="border-b border-gray-200 p-3 flex justify-between items-center dark:border-gray-700">
              <h2 class="text-lg font-bold text-gray-800 dark:text-white">Enter Bid for ${biddingTeamDisplayName}</h2>
              <div class="flex space-x-2">
                <button type="button" class="flex items-center border border-gray-300 rounded px-2 py-1 text-sm text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 focus:outline-none focus:ring-2 ${focusRingColor} dark:border-gray-600 dark:text-white dark:hover:bg-gray-700 threed" onclick="handleUndo(event)" ${!rounds.length ? "disabled" : ""} title="Undo">${Icons.Undo}Undo</button>
                <button type="button" class="flex items-center border border-gray-300 rounded px-2 py-1 text-sm text-gray-700 hover:bg-gray-100 transition disabled:opacity-50 focus:outline-none focus:ring-2 ${focusRingColor} dark:border-gray-600 dark:text-white dark:hover:bg-gray-700 threed" onclick="handleRedo(event)" ${!undoneRounds.length ? "disabled" : ""} title="Redo">${Icons.Redo}Redo</button>
                <button type="button"
          class="${penaltyBtnClass}"
          onclick="${penaltyBtnOnClick}"
          title="Flag Cheating">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10v4a1 1 0 0 0 1 1h2l5 3V6L6 9H4a1 1 0 0 0-1 1zm13-1.5v5a2.5 2.5 0 0 0 0-5z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 12a4 4 0 0 0 4-4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
  </button>
              </div>
            </div>
            <div class="p-4 score-input-container show">
              <form onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-white">Bid Amount</label>
                  <div class="flex flex-wrap gap-2">
                    ${presetBids.map(b => {
                      const isActive = b === "other" ? showCustomBid : (state.bidAmount === String(b) && !showCustomBid);
                      const btnBase = `px-3 py-1.5 text-sm font-medium threed rounded-lg transition focus:outline-none focus:ring-2 ${focusRingColor}`;
                      const btnActive = `${biddingTeam === "us" ? "bg-primary" : "bg-accent"} text-white shadow hover:brightness-95`;
                      const btnInactive = `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-500 dark:text-white dark:hover:bg-gray-600`;
                      return `<button type="button" class="${btnBase} ${isActive ? btnActive : btnInactive}" onclick="handleBidSelect('${b}')" aria-pressed="${isActive}">${b === "other" ? "Other" : b}</button>`;
                    }).join("")}
                  </div>
                  ${showCustomBid ? `<div class="mt-2"><input type="number" inputmode="numeric" pattern="[0-9]*" step="5" value="${customBidValue}" oninput="handleCustomBidChange(event)" placeholder="Enter custom bid" class="w-full sm:w-1/2 border border-gray-300 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 ${focusRingColor} transition dark:bg-gray-700 dark:border-gray-500 dark:text-white" /></div>` : ""}
                </div>
                ${(bidAmount || (showCustomBid && customBidValue && validateBid(customBidValue)==="")) ? renderPointsInput() : ""}
              </form>
            </div>
          </div>`;
      }
      function renderPointsInput() {
        const { biddingTeam, enterBidderPoints, usTeamName, demTeamName } = state;
        const biddingTeamName = biddingTeam === "us" ? (usTeamName || "Us") : (demTeamName || "Dem");
        const nonBiddingTeamName = biddingTeam === "us" ? (demTeamName || "Dem") : (usTeamName || "Us");
        const labelText = enterBidderPoints ? `${biddingTeamName} Points (Bidding)` : `${nonBiddingTeamName} Points (Non-Bidding)`;
        
        // Determine active button based on whose points are being entered
        const biddingTeamButtonActive = enterBidderPoints;
        const nonBiddingTeamButtonActive = !enterBidderPoints;

        // Team-specific colors for active buttons
        const biddingTeamColorClass = biddingTeam === "us" ? "bg-primary" : "bg-accent";
        const nonBiddingTeamColorClass = biddingTeam === "us" ? "bg-accent" : "bg-primary";
        
        const focusRingColor = biddingTeam === "us" ? "focus:ring-blue-500 dark:focus:ring-blue-400" : "focus:ring-red-500 dark:focus:ring-red-400";

        return `
          <div class="space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
            <div>
              <label class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-white">Enter Points For</label>
              <div class="flex gap-3">
                <button type="button" class="flex-1 rounded-full px-3 py-1.5 text-sm font-medium threed transition focus:outline-none focus:ring-2 focus:ring-opacity-50 ${biddingTeamButtonActive ? `${biddingTeamColorClass} text-white shadow hover:brightness-95` : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-500 dark:text-white dark:hover:bg-gray-600`} ${focusRingColor}" onclick="handleBiddingPointsToggle(true)" aria-pressed="${biddingTeamButtonActive}">${biddingTeamName}</button>
                <button type="button" class="flex-1 rounded-full px-3 py-1.5 text-sm font-medium threed transition focus:outline-none focus:ring-2 focus:ring-opacity-50 ${nonBiddingTeamButtonActive ? `${nonBiddingTeamColorClass} text-white shadow hover:brightness-95` : `bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-500 dark:text-white dark:hover:bg-gray-600`} ${focusRingColor}" onclick="handleBiddingPointsToggle(false)" aria-pressed="${nonBiddingTeamButtonActive}">${nonBiddingTeamName}</button>
              </div>
            </div>
            <div>
              <label for="pointsInput" class="block text-sm font-medium mb-1.5 text-gray-700 dark:text-white">${labelText}</label>
              <div class="flex flex-col sm:flex-row sm:items-center sm:gap-5">
                <input id="pointsInput" type="number" inputmode="numeric" pattern="[0-9]*" min="0" max="360" step="5" value="${ephemeralPoints}" oninput="ephemeralPoints = this.value" placeholder="Enter points" class="w-full sm:flex-grow border border-gray-300 rounded-xl px-3 py-1.5 text-sm focus:outline-none focus:ring-2 ${focusRingColor} transition dark:bg-gray-700 dark:border-gray-500 dark:text-white" />
                <button type="submit" class="mt-2 sm:mt-0 bg-blue-600 text-white px-4 py-1.5 text-sm rounded-xl shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400 threed">Submit</button>
              </div>
            </div>
          </div>`;
      }
      function renderHistoryCard() {
        const { rounds, usTeamName, demTeamName } = state;
        const labelUs = usTeamName || "Us";
        const labelDem = demTeamName || "Dem";
        if (!rounds.length) return ""; // Don't render if no history
        return `
          <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow">
            <div class="border-b border-gray-200 p-4 dark:border-gray-700">
              <h2 class="text-lg font-bold text-gray-800 dark:text-white">History</h2>
              <div class="grid grid-cols-3 gap-2 pt-3 font-medium text-gray-600 dark:text-white text-sm sm:text-base">
                <div class="text-left truncate">${labelUs}</div>
                <div class="text-center">Bid</div>
                <div class="text-right truncate">${labelDem}</div>
              </div>
            </div>
            <div class="p-4 max-h-60 overflow-y-auto no-scrollbar">
              <div class="space-y-2">
                ${rounds.map((round, idx) => {
                  const biddingTeamLabel = round.biddingTeam === "us" ? (round.usTeamNameOnRound || labelUs) : (round.demTeamNameOnRound || labelDem);
                  const arrow = round.biddingTeam === "us" ? `<span class="text-gray-800 dark:text-white">←</span><span class="ml-1 text-black dark:text-white">${round.bidAmount}</span>` : `<span class="mr-1 text-black dark:text-white">${round.bidAmount}</span><span class="text-gray-800 dark:text-white">→</span>`;
                  const bidDetails = `${biddingTeamLabel} bid ${round.bidAmount}`;
                  return `
                    <div key="${idx}" class="grid grid-cols-3 gap-2 p-2 bg-gray-50 rounded-xl dark:bg-gray-700 text-sm">
                      <div class="text-left text-gray-800 dark:text-white font-semibold">${round.runningTotals.us}</div>
                      <div class="text-center text-gray-600 dark:text-gray-400">${arrow}</div>
                      <div class="text-right text-gray-800 dark:text-white font-semibold">${round.runningTotals.dem}</div>
                    </div>`;
                }).join("")}
              </div>
            </div>
          </div>`;
      }
      function renderGameOverOverlay() {
        if (!state.gameOver) return "";
        const winnerLabel = state.winner === "us" ? (state.usTeamName || "Us") : (state.winner === "dem" ? (state.demTeamName || "Dem") : "It's a Tie");
        return `
<div data-overlay="gameover"
     class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md flex items-center justify-center p-4"
     style="z-index:49;"
     role="alertdialog" aria-labelledby="gameOverTitle" aria-modal="true">
            <div class="bg-white dark:bg-gray-800 w-full max-w-md rounded-xl shadow-lg text-center">
              <div class="p-6">
                <h2 id="gameOverTitle" class="text-3xl font-bold mb-2 animate-fadeIn text-gray-800 dark:text-white">Game Over!</h2>
                <p class="text-xl mb-1 animate-fadeIn text-gray-700 dark:text-white">${winnerLabel} Wins!</p>
                <p class="text-sm mb-6 animate-fadeIn text-gray-500 dark:text-gray-400">(${state.victoryMethod || 'Game Ended'})</p>
                <div class="flex space-x-4 justify-center">
                  <button onclick="handleGameOverSaveClick(event)" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-400 threed" type="button">Save Game</button>
                  <button onclick="handleNewGame()" class="bg-blue-600 text-white px-6 py-3 rounded-xl shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-400 threed" type="button">New Game</button>
                </div>
              </div>
            </div>
          </div>`;
      }
      // (renderReadOnlyGameDetails, renderSavedGames, renderFreezerGames, renderStatisticsContent, renderTeamStatsTable - these remain substantial and are called by modal openers)
      function renderReadOnlyGameDetails(game) {
        const { rounds, timestamp, usTeamName, demTeamName, durationMs, winner, finalScore, victoryMethod } = game;
        const usDisp = usTeamName || "Us", demDisp = demTeamName || "Dem";
        const usScore = finalScore?.us || 0, demScore = finalScore?.dem || 0;
        const usWinner = winner === "us", demWinner = winner === "dem";
        const dateStr = new Date(timestamp).toLocaleString([], { year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });

        // Determine sandbag for winner
        let sandbagResult = "N/A";
        if (winner === "us" || winner === "dem") {
          const winnerTeamName = winner === "us" ? usDisp : demDisp;
          sandbagResult = isGameSandbagForTeam(game, winnerTeamName) ? "Yes" : "No";
        }
        
        const roundHtml = (rounds || []).map((r, idx) => {
            const bidTeam = r.biddingTeam === "us" ? (r.usTeamNameOnRound || usDisp) : (r.demTeamNameOnRound || demDisp);
            const arrow = r.biddingTeam === "us" ? "←" : "→";
            const bidDisplay = `${r.bidAmount} ${arrow}`;
            return `
            <div class="grid grid-cols-5 gap-1 p-2 bg-gray-50 rounded-xl dark:bg-gray-700 text-sm sm:text-base mb-2">
              <div class="text-left font-medium col-span-1 ${r.biddingTeam === "us" && r.usPoints < r.bidAmount ? 'text-red-500' : 'text-gray-800 dark:text-white'}">${r.runningTotals.us}</div>
              <div class="text-center text-gray-600 dark:text-gray-300 text-xs sm:text-sm col-span-3">
                <span class="bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded-full">${bidTeam} bid ${bidDisplay}</span>
              </div>
              <div class="text-right font-medium col-span-1 ${r.biddingTeam === "dem" && r.demPoints < r.bidAmount ? 'text-red-500' : 'text-gray-800 dark:text-white'}">${r.runningTotals.dem}</div>
            </div>`;
        }).join("");

        return `
          <div class="space-y-4"> <!-- Reduced vertical spacing -->
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-3 shadow-sm"> <!-- Reduced padding -->
              <div class="flex flex-col sm:flex-row justify-between items-center mb-2"> <!-- Reduced margin -->
                <h4 class="text-xl font-bold text-gray-800 dark:text-white text-center sm:text-left">${usDisp} vs ${demDisp}</h4>
                <span class="bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">${dateStr}</span>
              </div>
              <div class="flex justify-around items-center text-center">
                <div class="${usWinner ? 'text-green-500 dark:text-green-400' : 'text-gray-800 dark:text-white'}">
                  <div class="text-sm">${usDisp}</div><div class="text-2xl font-bold">${usScore}</div>
                  ${usWinner ? '<div class="text-xs font-medium">WINNER</div>' : ''}
                </div>
                <div class="text-gray-400 dark:text-gray-500 text-lg">vs</div>
                <div class="${demWinner ? 'text-green-500 dark:text-green-400' : 'text-gray-800 dark:text-white'}">
                  <div class="text-sm">${demDisp}</div><div class="text-2xl font-bold">${demScore}</div>
                  ${demWinner ? '<div class="text-xs font-medium">WINNER</div>' : ''}
                </div>
              </div>
              ${victoryMethod ? `<p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-1">(${victoryMethod})</p>` : ''}
            </div>
            <div class="flex flex-row gap-2 sm:gap-4 mb-1"> <!-- Side by side, tighter gap -->
              <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl p-2 shadow-sm flex flex-col items-start"> <!-- Tighter padding -->
                <span class="text-xs font-semibold text-gray-800 dark:text-white">Sandbag?</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">${sandbagResult}</span>
              </div>
              <div class="flex-1 bg-white dark:bg-gray-800 rounded-xl p-2 shadow-sm flex flex-col items-end"> <!-- Tighter padding -->
                <span class="text-xs font-semibold text-gray-800 dark:text-white">Duration</span>
                <span class="text-sm text-gray-700 dark:text-gray-300">${durationMs ? formatDuration(durationMs) : "N/A"}</span>
              </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl p-3 shadow-sm"> <!-- Reduced padding -->
              <p class="font-semibold text-gray-800 dark:text-white mb-1">Round History</p>
              <div class="space-y-2 max-h-60 overflow-y-auto rounded-xl pr-1 no-scrollbar">${roundHtml || '<p class="text-gray-500">No rounds.</p>'}</div>
            </div>
            <div class="flex justify-center"><button type="button" onclick="closeViewSavedGameModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white transition-colors threed">Close</button></div>
          </div>`;
      }
      // --- Saved Games Modal (New Functions) ---
      function switchGamesTab(tabType) {
        const completedTab = document.getElementById('completedGamesTab');
        const freezerTab = document.getElementById('freezerGamesTab');
        const completedSection = document.getElementById('completedGamesSection');
        const freezerSection = document.getElementById('freezerGamesSection');
        
        const activeClasses = ['border-blue-600', 'text-blue-600', 'dark:text-blue-400', 'dark:border-blue-400'];
        const inactiveClasses = ['border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-300'];

        if (tabType === 'completed') {
            completedTab.classList.add(...activeClasses); completedTab.classList.remove(...inactiveClasses);
            freezerTab.classList.add(...inactiveClasses); freezerTab.classList.remove(...activeClasses);
            completedSection.classList.remove('hidden'); freezerSection.classList.add('hidden');
        } else {
            freezerTab.classList.add(...activeClasses); freezerTab.classList.remove(...inactiveClasses);
            completedTab.classList.add(...inactiveClasses); completedTab.classList.remove(...activeClasses);
            freezerSection.classList.remove('hidden'); completedSection.classList.add('hidden');
        }
        document.getElementById('gameSearchInput').value = '';
        document.getElementById('gameSortSelect').value = 'newest';
        renderGamesWithFilter();
      }
      function updateGamesCount() {
        const savedGames = getLocalStorage("savedGames");
        const freezerGames = getLocalStorage("freezerGames");
        document.getElementById('completedGamesCount').textContent = savedGames.length;
        document.getElementById('freezerGamesCount').textContent = freezerGames.length;
        document.getElementById('noCompletedGamesMessage').classList.toggle('hidden', savedGames.length > 0);
        document.getElementById('noFreezerGamesMessage').classList.toggle('hidden', freezerGames.length > 0);
      }
      function filterGames() { renderGamesWithFilter(); }
      function sortGames() { renderGamesWithFilter(); }
      function renderGamesWithFilter() {
        const searchTerm = document.getElementById('gameSearchInput').value.toLowerCase();
        const sortOption = document.getElementById('gameSortSelect').value;
        const isCompletedTabActive = !document.getElementById('completedGamesSection').classList.contains('hidden');
        isCompletedTabActive ? renderSavedGamesList(searchTerm, sortOption) : renderFreezerGamesList(searchTerm, sortOption);
      }
      function renderSavedGamesList(searchTerm = '', sortOption = 'newest') {
        let games = getLocalStorage("savedGames");
        if (searchTerm) {
            games = games.filter(g => 
                (g.usTeamName || "Us").toLowerCase().includes(searchTerm) || 
                (g.demTeamName || "Dem").toLowerCase().includes(searchTerm) ||
                new Date(g.timestamp).toLocaleString().toLowerCase().includes(searchTerm)
            );
        }
        games = sortGamesBy(games, sortOption, true); // true for completed games
        const container = document.getElementById("savedGamesList");
        document.getElementById('noCompletedGamesMessage').classList.toggle('hidden', games.length > 0);
        container.innerHTML = games.map((g, idx) => { // Use original index for deletion/viewing
            const originalIndex = getLocalStorage("savedGames").findIndex(sg => sg.timestamp === g.timestamp); // Find original index
            const usS = g.finalScore.us, demS = g.finalScore.dem;
            const usW = g.winner === "us", demW = g.winner === "dem";
            const dateStr = new Date(g.timestamp).toLocaleString([], { year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"});
            return `
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-shadow dark:bg-gray-800 dark:border-gray-700 cursor-pointer relative" onclick="viewSavedGame(${originalIndex})">
              ${usW ? `<div class="absolute top-0 right-2 bg-green-100 text-green-800 text-xs font-semibold px-2 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">Winner: ${g.usTeamName || "Us"}</div>` : ''}
              ${demW ? `<div class="absolute top-0 right-2 bg-green-100 text-green-800 text-xs font-semibold px-2 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">Winner: ${g.demTeamName || "Dem"}</div>` : ''}
              <div class="p-5">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${g.usTeamName || "Us"} vs ${g.demTeamName || "Dem"}</h3>
                    <div class="text-sm text-gray-500 dark:text-gray-400">${dateStr}</div>
                  </div>
                  <div class="flex space-x-1">
                    <button onclick="viewSavedGame(${originalIndex}); event.stopPropagation();" class="p-1.5 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="View"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg></button>
                    <button onclick="deleteSavedGame(${originalIndex}); event.stopPropagation();" class="p-1.5 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 rounded-full focus:outline-none focus:ring-2 focus:ring-red-300" aria-label="Delete">${Icons.Trash}</button>
                  </div>
                </div>
                <div class="text-sm">
                  <span class="${usW ? 'text-green-600 font-bold' : 'text-gray-700 dark:text-gray-300'}">${g.usTeamName || "Us"}: ${usS}</span> | 
                  <span class="${demW ? 'text-green-600 font-bold' : 'text-gray-700 dark:text-gray-300'}">${g.demTeamName || "Dem"}: ${demS}</span>
                </div>
                <div class="mt-2 flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                  ${g.victoryMethod ? `<span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-300">${g.victoryMethod}</span>` : ''}
                  ${g.durationMs ? `<span>${formatDuration(g.durationMs)}</span>` : ''}
                </div>
              </div>
            </div>`;
        }).join("") || (!searchTerm ? "" : `<p class="text-gray-500 col-span-full text-center">No completed games match "${searchTerm}".</p>`);
      }
      function renderFreezerGamesList(searchTerm = '', sortOption = 'newest') {
        let games = getLocalStorage("freezerGames");
        if (searchTerm) {
            games = games.filter(g => 
                (g.usName || "Us").toLowerCase().includes(searchTerm) || 
                (g.demName || "Dem").toLowerCase().includes(searchTerm) ||
                new Date(g.timestamp).toLocaleString().toLowerCase().includes(searchTerm)
            );
        }
        games = sortGamesBy(games, sortOption, false); // false for freezer games
        const container = document.getElementById("freezerGamesList");
        document.getElementById('noFreezerGamesMessage').classList.toggle('hidden', games.length > 0);
        container.innerHTML = games.map((g, idx) => {
            const originalIndex = getLocalStorage("freezerGames").findIndex(fg => fg.timestamp === g.timestamp);
            const usS = g.finalScore.us, demS = g.finalScore.dem;
            const dateStr = new Date(g.timestamp).toLocaleString([], { year:"numeric", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"});
            const leadInfo = usS > demS ? `${g.usName || "Us"} leads by ${usS - demS}` : (demS > usS ? `${g.demName || "Dem"} leads by ${demS - usS}` : "Tied");
            return `
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-lg transition-shadow dark:bg-gray-800 dark:border-gray-700 cursor-pointer relative" onclick="loadFreezerGame(${originalIndex})">
              <div class="absolute top-0 right-2 bg-yellow-100 text-yellow-800 text-xs font-semibold px-2 py-0.5 rounded-full dark:bg-yellow-900 dark:text-yellow-300">${leadInfo}</div>
              <div class="p-5">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${g.usName || "Us"} vs ${g.demName || "Dem"}</h3>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Frozen: ${dateStr}</div>
                  </div>
                  <div class="flex space-x-1">
                    <button onclick="loadFreezerGame(${originalIndex}); event.stopPropagation();" class="p-1.5 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-300" aria-label="Load">${Icons.Load}</button>
                    <button onclick="deleteFreezerGame(${originalIndex}); event.stopPropagation();" class="p-1.5 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 rounded-full focus:outline-none focus:ring-2 focus:ring-red-300" aria-label="Delete">${Icons.Trash}</button>
                  </div>
                </div>
                <div class="text-sm text-gray-700 dark:text-gray-300">
                  <span>${g.usName || "Us"}: ${usS}</span> | <span>${g.demName || "Dem"}: ${demS}</span>
                </div>
                <div class="mt-2 flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                  ${g.lastBid ? `<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-full dark:bg-indigo-900 dark:text-indigo-300">Last Bid: ${g.lastBid}</span>` : ''}
                  ${g.accumulatedTime ? `<span>Played: ${formatDuration(g.accumulatedTime)}</span>` : ''}
                </div>
              </div>
            </div>`;
        }).join("") || (!searchTerm ? "" : `<p class="text-gray-500 col-span-full text-center">No frozen games match "${searchTerm}".</p>`);
      }
      function sortGamesBy(games, sortOption, isCompletedGameType) {
        const sorted = [...games]; // Create a mutable copy
        switch (sortOption) {
          case 'oldest': sorted.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); break;
          case 'highest': sorted.sort((a, b) => Math.max(b.finalScore.us, b.finalScore.dem) - Math.max(a.finalScore.us, a.finalScore.dem)); break;
          case 'lowest': sorted.sort((a, b) => Math.max(a.finalScore.us, a.finalScore.dem) - Math.max(b.finalScore.us, b.finalScore.dem)); break;
          case 'newest': default: sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); break;
        }
        return sorted;
      }
      function detectSandbag(rounds, winner, threshold = 2) { /* Placeholder */ return "N/A"; }
      // --- Statistics Modal Rendering ---
      function renderStatisticsContent() {
        const stats = getStatistics();
        let content = "";
        if (!stats.totalGames && !stats.teamsData.length) {
            content = `<div class="py-8 text-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 mx-auto text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg><p class="mt-4 text-gray-600 dark:text-gray-400 text-lg">No stats yet. Play some games!</p><button onclick="handleNewGame(); closeMenuOverlay(); closeStatisticsModal();" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm">Start New Game</button></div>`;
        } else {
            const statCard = (title, value, iconSvg, color) => `
                <div class="bg-gradient-to-br from-${color}-50 to-${color}-100 dark:from-gray-700 dark:to-gray-800 rounded-lg p-2.5 shadow-sm">
                  <div class="flex items-center"><div class="p-1.5 bg-${color}-500 rounded-lg text-white">${iconSvg}</div>
                    <div class="ml-2"><p class="text-xs uppercase font-semibold text-gray-500 dark:text-gray-400">${title}</p><p class="text-lg font-bold text-gray-900 dark:text-white">${value}</p></div>
                  </div></div>`;
            
            const icons = {
                avgBid: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>',
                timePlayed: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                gamesPlayed: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>'
            };
            let statCardsHtml = stats.totalGames > 0 ? `<div class="grid grid-cols-3 gap-2 mb-4">
                ${statCard("Avg Bid", stats.overallAverageBid, icons.avgBid, "blue")}
                ${statCard("Time Played", formatDuration(stats.totalTimePlayedMs), icons.timePlayed, "purple")}
                ${statCard("Games Played", stats.totalGames, icons.gamesPlayed, "green")}
            </div>` : "";

            let statSelector = `<div class="mt-6 mb-4"><label for="additionalStatSelector" class="block text-sm font-medium text-gray-700 dark:text-white mb-2">Team Statistics</label><div class="relative"><select id="additionalStatSelector" class="appearance-none block w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2.5 px-3 text-gray-700 dark:text-white leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:focus:ring-blue-400"><option value="games">Games Played</option><option value="avgBid">Avg Bid</option><option value="bidSuccessPct">Bid Success %</option><option value="sandbagger">Sandbagger?</option><option value="360s">360s</option></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700 dark:text-gray-300"><svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div></div></div>`;
            let teamStatsTable = renderTeamStatsTable(stats.teamsData, "games");
            content = `${statCardsHtml}${statSelector}<div id="teamStatsTableWrapper">${teamStatsTable}</div>`;
        }
        document.getElementById("statisticsModalContent").innerHTML = content;
        const selector = document.getElementById("additionalStatSelector");
        if (selector) {
            selector.addEventListener("change", function () {
                document.getElementById("teamStatsTableWrapper").innerHTML = renderTeamStatsTable(getStatistics().teamsData, this.value);
            });
        }
      }
      function getStatistics() {
        const savedGames = getLocalStorage("savedGames").filter(g => g && Array.isArray(g.rounds) && g.rounds.length > 0);
        const teamData = {}; // Using object for easier access by team name
        let totalBids = 0, sumOfBids = 0, totalGameDuration = 0;

        savedGames.forEach(game => {
            totalGameDuration += game.durationMs || 0;
            const teamsInGame = [game.usTeamName || "Us", game.demTeamName || "Dem"];
            teamsInGame.forEach(teamName => {
                if (!teamData[teamName]) {
                    teamData[teamName] = { name: teamName, gamesPlayed: 0, wins: 0, totalBidAmount: 0, bidsMade: 0, bidsSucceeded: 0, handsPlayed: 0, handsWon: 0, sandbagGames: 0, perfect360s: 0, lastPlayed: 0 };
                }
                teamData[teamName].gamesPlayed++;
                if (new Date(game.timestamp).getTime() > teamData[teamName].lastPlayed) {
                    teamData[teamName].lastPlayed = new Date(game.timestamp).getTime();
                }
            });

            if (game.winner === "us") teamData[game.usTeamName || "Us"].wins++;
            else if (game.winner === "dem") teamData[game.demTeamName || "Dem"].wins++;
            
            if (isGameSandbagForTeam(game, game.usTeamName || "Us")) teamData[game.usTeamName || "Us"].sandbagGames++;
            if (isGameSandbagForTeam(game, game.demTeamName || "Dem")) teamData[game.demTeamName || "Dem"].sandbagGames++;

            game.rounds.forEach(round => {
                sumOfBids += round.bidAmount; totalBids++;
                const biddingTeamName = round.biddingTeam === "us" ? (game.usTeamName || "Us") : (game.demTeamName || "Dem");
                const nonBiddingTeamName = round.biddingTeam === "us" ? (game.demTeamName || "Dem") : (game.usTeamName || "Us");

                teamData[biddingTeamName].handsPlayed++;
                teamData[nonBiddingTeamName].handsPlayed++;
                teamData[biddingTeamName].bidsMade++;
                teamData[biddingTeamName].totalBidAmount += round.bidAmount;

                if ((round.biddingTeam === "us" && round.usPoints >= round.bidAmount) || (round.biddingTeam === "dem" && round.demPoints >= round.bidAmount)) {
                    teamData[biddingTeamName].bidsSucceeded++;
                }
                if (round.usPoints > round.demPoints) teamData[game.usTeamName || "Us"].handsWon++;
                else if (round.demPoints > round.usPoints) teamData[game.demTeamName || "Dem"].handsWon++;
                
                if (round.usPoints === 360) teamData[game.usTeamName || "Us"].perfect360s++;
                if (round.demPoints === 360) teamData[game.demTeamName || "Dem"].perfect360s++;
            });
        });

        const teamsArray = Object.values(teamData).map(t => ({
            ...t,
            winPercent: t.gamesPlayed > 0 ? ((t.wins / t.gamesPlayed) * 100).toFixed(1) : "0.0",
            avgBid: t.bidsMade > 0 ? (t.totalBidAmount / t.bidsMade).toFixed(0) : "N/A",
            bidSuccessPct: t.bidsMade > 0 ? ((t.bidsSucceeded / t.bidsMade) * 100).toFixed(1) : "N/A",
            sandbagger: t.gamesPlayed > 0 && (t.sandbagGames / t.gamesPlayed > 0.5) ? "Yes" : "No", // Example threshold
            count360: t.perfect360s
        })).sort((a,b) => b.lastPlayed - a.lastPlayed); // Sort by most recently played

        return {
            totalGames: savedGames.length,
            overallAverageBid: totalBids > 0 ? (sumOfBids / totalBids).toFixed(0) : "N/A",
            teamsData: teamsArray,
            totalTimePlayedMs: totalGameDuration
        };
      }
      function isGameSandbagForTeam(game, teamName, threshold = 2) {
        let sandbagOpportunities = 0;
        const targetTeamKey = (game.usTeamName || "Us") === teamName ? "us" : "dem";
        const opponentTeamKey = targetTeamKey === "us" ? "dem" : "us";
        const opponentName = (game.usTeamName || "Us") === teamName ? (game.demTeamName || "Dem") : (game.usTeamName || "Us");

        game.rounds.forEach(round => {
            // Check if opponent bid and went set
            if (round.biddingTeam === opponentTeamKey && round[`${opponentTeamKey}Points`] < 0) {
                // Check if the target team scored significantly (e.g., >= 80 or made bid equivalent if they had bid)
                if (round[`${targetTeamKey}Points`] >= 80 || round[`${targetTeamKey}Points`] >= round.bidAmount) {
                    sandbagOpportunities++;
                }
            }
        });
        return sandbagOpportunities >= threshold;
      }
      function renderTeamStatsTable(teamsData, additionalStatKey) {
        const headers = { games: "Games", avgBid: "Avg Bid", bidSuccessPct: "Bid Success %", sandbagger: "Sandbagger?", "360s": "360s" };
        let tableHTML = `<div id="teamStatsTableContainer" class="mt-4"><div class="overflow-x-auto -mx-4 sm:mx-0"><div class="inline-block min-w-full align-middle"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600"><thead><tr>
            <th scope="col" class="py-3 pl-4 pr-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 sticky left-0 z-10">Team</th>
            <th scope="col" class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700">Win %</th>
            <th scope="col" class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700">${headers[additionalStatKey] || 'Stat'}</th>
            <th scope="col" class="pl-3 pr-4 py-3 text-center text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700">Del</th>
            </tr></thead><tbody class="divide-y divide-gray-200 dark:divide-gray-600 bg-white dark:bg-gray-800">`;
        teamsData.forEach((team, index) => {
            const rowClass = index % 2 === 0 ? "bg-white dark:bg-gray-800" : "bg-gray-50 dark:bg-gray-700"; // Ensure sticky respects row color
            const lookup = {
  games   : team.gamesPlayed,
  "360s"  : team.count360,
  avgBid  : team.avgBid,
  bidSuccessPct : team.bidSuccessPct,
  sandbagger    : team.sandbagger
};
let statVal = lookup[additionalStatKey] ?? '0';

            if (additionalStatKey.includes('Pct') && typeof statVal === 'string' && !statVal.includes('%') && statVal !== 'N/A') statVal += '%';

            tableHTML += `<tr class="${rowClass}">
                <td class="whitespace-nowrap py-3.5 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-white sticky left-0 z-10 ${rowClass}">${team.name}</td>
                <td class="whitespace-nowrap px-3 py-3.5 text-sm text-center text-gray-700 dark:text-gray-300">${team.winPercent}%</td>
                <td class="whitespace-nowrap px-3 py-3.5 text-sm text-center text-gray-700 dark:text-gray-300">${statVal}</td>
                <td class="whitespace-nowrap pl-3 pr-4 py-3.5 text-sm text-center"><button onclick="handleDeleteTeam('${team.name}'); event.stopPropagation();" class="text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-full p-1.5 dark:text-red-400 dark:hover:text-red-300" aria-label="Delete Team">${Icons.Trash}</button></td></tr>`;
        });
        tableHTML += `</tbody></table></div></div></div>`;
        return tableHTML;
      }
      function handleDeleteTeam(teamName) {
        openConfirmationModal(`Delete team "${teamName}" and all game data? This is irreversible.`, () => {
            const teams = getTeamsObject(); delete teams[teamName]; setTeamsObject(teams);
            let savedGames = getLocalStorage("savedGames");
            savedGames = savedGames.filter(g => (g.usTeamName || "Us") !== teamName && (g.demTeamName || "Dem") !== teamName);
            setLocalStorage("savedGames", savedGames);
            let freezerGames = getLocalStorage("freezerGames");
            freezerGames = freezerGames.filter(g => (g.usName || "Us") !== teamName && (g.demName || "Dem") !== teamName);
            setLocalStorage("freezerGames", freezerGames);
            closeConfirmationModal();
            renderStatisticsContent(); // Refresh stats modal
        }, closeConfirmationModal);
      }

      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        // Removed performDataMigration();
        initializeDarkMode();
        initializeTheme(); // Predefined themes
        initializeCustomThemeColors(); // Custom primary/accent
        loadCurrentGameState(); // Load after theme

        const darkModeToggle = document.getElementById("darkModeToggle");
        if (darkModeToggle) darkModeToggle.addEventListener("change", (e) => {
            const isDark = e.target.checked;
            document.documentElement.classList.toggle("dark", isDark);
            localStorage.setItem(DARK_MODE_KEY, isDark);
            updateMetaThemeColor(isDark);
        });
        
        // Pro mode toggle (in settings modal, not main nav)
        const proModeToggleModal = document.getElementById("proModeToggleModal");
        if (proModeToggleModal) {
            proModeToggleModal.checked = JSON.parse(localStorage.getItem(PRO_MODE_KEY)) || false;
            proModeToggleModal.addEventListener("change", (e) => toggleProMode(e.target));
        }
        updateProModeUI(JSON.parse(localStorage.getItem(PRO_MODE_KEY)) || false); // Initial UI update

        document.getElementById("closeViewSavedGameModalBtn")?.addEventListener("click", (e) => { e.stopPropagation(); closeViewSavedGameModal(); });
        document.getElementById("closeSavedGamesModalBtn")?.addEventListener("click", (e) => { e.stopPropagation(); closeSavedGamesModal(); });
        document.getElementById("teamSelectionForm")?.addEventListener("submit", handleTeamSelectionSubmit);

        // Close modals on outside click (simplified)
        const allModals = ["savedGamesModal", "viewSavedGameModal", "aboutModal", "statisticsModal", "teamSelectionModal", "settingsModal", "themeModal", "confirmationModal", "presetEditorModal"];
        document.addEventListener("click", (e) => {
            allModals.forEach(id => {
                const modalEl = document.getElementById(id);
                if (modalEl && !modalEl.classList.contains("hidden") && e.target === modalEl) {
                    // Find the specific close function if available, otherwise generic close
                    if (id === "savedGamesModal") closeSavedGamesModal();
                    else if (id === "viewSavedGameModal") closeViewSavedGameModal();
                    else if (id === "aboutModal") closeAboutModal();
                    else if (id === "statisticsModal") closeStatisticsModal();
                    else if (id === "teamSelectionModal") closeTeamSelectionModal();
                    else if (id === "settingsModal") closeSettingsModal();
                    else if (id === "themeModal") closeThemeModal(null);
                    else if (id === "confirmationModal") closeConfirmationModal();
                    else if (id === "presetEditorModal") closePresetEditorModal();
                }
            });
        });
         // Hamburger menu swipe gesture (simple version)
        let touchStartX = 0;
        document.body.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
        document.body.addEventListener('touchend', e => {
            const touchEndX = e.changedTouches[0].clientX;
            if (touchStartX < 50 && touchEndX > touchStartX + 50) { // Swipe right from left edge
                 if (!document.getElementById("menu").classList.contains("show")) toggleMenu(e); // Open if closed
            } else if (document.getElementById("menu").classList.contains("show") && touchEndX < touchStartX - 50) { // Swipe left when menu open
                 if (document.getElementById("menu").classList.contains("show")) toggleMenu(e); // Close if open
            }
        }, { passive: true });
      });

      // SAFETY-NET: make sure the app starts with pointer-events ON
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.remove('modal-open');          // scrolling again
  document.getElementById('app')?.classList.remove('modal-active');
  // also be sure every .modal starts hidden
  document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
});

      if ('serviceWorker' in navigator) {
        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          window.location.reload();
          refreshing = true;
        });
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js') // Assuming sw is in root
                .then(registration => {
                    registration.onupdatefound = () => {
                        const installingWorker = registration.installing;
                        if (installingWorker == null) return;
                        installingWorker.onstatechange = () => {
                            if (installingWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // New update available
                                    if (confirm('New version available! Reload to update?')) {
                                        installingWorker.postMessage({ type: 'SKIP_WAITING' });
                                    }
                                }
                            }
                        };
                    };
                }).catch(error => console.error('Service Worker registration failed:', error));
        });
      }
    </script>
    <script>
      function undoPenaltyFlag() {
        updateState({ pendingPenalty: null });
        showSaveIndicator("Penalty removed");
      }
    </script>
</body>
</html>
